# IMPORTANT: To update Docker image version, please search and update ":{previous_version}"
# in this file to the new version number, and **ALSO** update the version number below:
# PyTorchDockerVersion:282
# Caffe2DockerVersion:238

docker_config_defaults: &docker_config_defaults
  user: jenkins
  aws_auth:
    # This IAM user only allows read-write access to ECR
    aws_access_key_id: ${CIRCLECI_AWS_ACCESS_KEY_FOR_ECR_READ_WRITE_V3}
    aws_secret_access_key: ${CIRCLECI_AWS_SECRET_KEY_FOR_ECR_READ_WRITE_V3}

# NOTE: We only perform the merge in build step and not in test step, because
# all source files will be shared from build to test
install_official_git_client: &install_official_git_client
  name: Install Official Git Client
  no_output_timeout: "1h"
  command: |
    set -e
    sudo apt-get -qq update
    sudo apt-get -qq install openssh-client git

setup_ci_environment: &setup_ci_environment
  name: Set Up CI Environment
  no_output_timeout: "1h"
  command: |
    set -e

    curl -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -
    echo "deb https://nvidia.github.io/libnvidia-container/ubuntu14.04/amd64 /" | sudo tee -a /etc/apt/sources.list.d/nvidia-docker.list
    echo "deb https://nvidia.github.io/nvidia-container-runtime/ubuntu14.04/amd64 /" | sudo tee -a /etc/apt/sources.list.d/nvidia-docker.list
    echo "deb https://nvidia.github.io/nvidia-docker/ubuntu14.04/amd64 /" | sudo tee -a /etc/apt/sources.list.d/nvidia-docker.list

    sudo apt-get -qq update
    sudo apt-get -qq remove linux-image-generic linux-headers-generic linux-generic
    sudo apt-get -qq install \
      linux-headers-$(uname -r) \
      linux-image-generic \
      moreutils \
      nvidia-docker2 \
      expect-dev

    sudo pkill -SIGHUP dockerd

    sudo pip -q install awscli==1.16.35

    if [[ "${JOB_BASE_NAME}" == *-test* || "${JOB_BASE_NAME}" == smoke* || "${JOB_BASE_NAME}" == binary* ]]; then
      if [ -n "${CUDA_VERSION}" ]; then
        wget 'https://s3.amazonaws.com/ossci-linux/nvidia_driver/NVIDIA-Linux-x86_64-410.79.run'
        sudo /bin/bash ./NVIDIA-Linux-x86_64-410.79.run -s --no-drm
        nvidia-smi
      fi
    fi

    if [[ "${JOB_BASE_NAME}" == *-build ]]; then
      echo "declare -x IN_CIRCLECI=1" > /home/circleci/project/env
      echo "declare -x COMMIT_SOURCE=${CIRCLE_BRANCH}" >> /home/circleci/project/env
      echo "declare -x PYTHON_VERSION=${PYTHON_VERSION}" >> /home/circleci/project/env
      echo "declare -x SCCACHE_BUCKET=ossci-compiler-cache-circleci-v2" >> /home/circleci/project/env
      if [ -n "${CUDA_VERSION}" ]; then
        echo "declare -x TORCH_CUDA_ARCH_LIST=5.2" >> /home/circleci/project/env
      fi
      export SCCACHE_MAX_JOBS=`expr $(nproc) - 1`
      export MEMORY_LIMIT_MAX_JOBS=8  # the "large" resource class on CircleCI has 32 CPU cores, if we use all of them we'll OOM
      export MAX_JOBS=$(( ${SCCACHE_MAX_JOBS} > ${MEMORY_LIMIT_MAX_JOBS} ? ${MEMORY_LIMIT_MAX_JOBS} : ${SCCACHE_MAX_JOBS} ))
      echo "declare -x MAX_JOBS=${MAX_JOBS}" >> /home/circleci/project/env

      # This IAM user allows write access to S3 bucket for sccache
      echo "declare -x AWS_ACCESS_KEY_ID=${CIRCLECI_AWS_ACCESS_KEY_FOR_SCCACHE_S3_BUCKET_V3}" >> /home/circleci/project/env
      echo "declare -x AWS_SECRET_ACCESS_KEY=${CIRCLECI_AWS_SECRET_KEY_FOR_SCCACHE_S3_BUCKET_V3}" >> /home/circleci/project/env
    fi

    # This IAM user only allows read-write access to ECR
    export AWS_ACCESS_KEY_ID=${CIRCLECI_AWS_ACCESS_KEY_FOR_ECR_READ_WRITE_V3}
    export AWS_SECRET_ACCESS_KEY=${CIRCLECI_AWS_SECRET_KEY_FOR_ECR_READ_WRITE_V3}
    eval $(aws ecr get-login --region us-east-1 --no-include-email)


##############################################################################
# Linux build defaults
##############################################################################

pytorch_linux_build_defaults: &pytorch_linux_build_defaults
  resource_class: large
  machine:
    image: default
  steps:
  - run:
      <<: *install_official_git_client
  - checkout
  - run:
      <<: *setup_ci_environment
  - run:
      name: Build
      no_output_timeout: "1h"
      command: |
        set -e
        # Pull Docker image and run build
        echo "DOCKER_IMAGE: "${DOCKER_IMAGE}
        docker pull ${DOCKER_IMAGE} >/dev/null
        export id=$(docker run -t -d -w /var/lib/jenkins ${DOCKER_IMAGE})

        git submodule sync && git submodule update -q --init

        docker cp /home/circleci/project/. $id:/var/lib/jenkins/workspace

        export COMMAND='((echo "export JOB_BASE_NAME=${JOB_BASE_NAME}" && echo "source ./workspace/env" && echo "sudo chown -R jenkins workspace && cd workspace && .jenkins/pytorch/build.sh") | docker exec -u jenkins -i "$id" bash) 2>&1'
        echo ${COMMAND} > ./command.sh && unbuffer bash ./command.sh | ts

        # Push intermediate Docker image for next phase to use
        if [ -z "${BUILD_ONLY}" ]; then
          export COMMIT_DOCKER_IMAGE=${DOCKER_IMAGE}-${CIRCLE_SHA1}
          docker commit "$id" ${COMMIT_DOCKER_IMAGE}
          docker push ${COMMIT_DOCKER_IMAGE}
        fi

pytorch_linux_test_defaults: &pytorch_linux_test_defaults
  machine:
    image: default
  steps:
  - run:
      <<: *setup_ci_environment
  - run:
      name: Test
      no_output_timeout: "1h"
      command: |
        set -e
        export COMMIT_DOCKER_IMAGE=${DOCKER_IMAGE}-${CIRCLE_SHA1}
        echo "DOCKER_IMAGE: "${COMMIT_DOCKER_IMAGE}
        docker pull ${COMMIT_DOCKER_IMAGE} >/dev/null
        if [ -n "${CUDA_VERSION}" ]; then
          export id=$(docker run --runtime=nvidia -t -d -w /var/lib/jenkins ${COMMIT_DOCKER_IMAGE})
        else
          export id=$(docker run -t -d -w /var/lib/jenkins ${COMMIT_DOCKER_IMAGE})
        fi
        if [ -n "${MULTI_GPU}" ]; then
          export COMMAND='((echo "export JOB_BASE_NAME=${JOB_BASE_NAME}" && echo "source ./workspace/env" && echo "sudo chown -R jenkins workspace && cd workspace && .jenkins/pytorch/multigpu-test.sh") | docker exec -u jenkins -i "$id" bash) 2>&1'
        else
          export COMMAND='((echo "export JOB_BASE_NAME=${JOB_BASE_NAME}" && echo "source ./workspace/env" && echo "sudo chown -R jenkins workspace && cd workspace && .jenkins/pytorch/test.sh") | docker exec -u jenkins -i "$id" bash) 2>&1'
        fi
        echo ${COMMAND} > ./command.sh && unbuffer bash ./command.sh | ts

caffe2_linux_build_defaults: &caffe2_linux_build_defaults
  resource_class: large
  machine:
    image: default
  steps:
  - run:
      <<: *install_official_git_client
  - checkout
  - run:
      <<: *setup_ci_environment
  - run:
      name: Build
      no_output_timeout: "1h"
      command: |
        set -e
        cat >/home/circleci/project/ci_build_script.sh <<EOL
        # =================== The following code will be executed inside Docker container ===================
        set -ex
        export BUILD_ENVIRONMENT="$BUILD_ENVIRONMENT"

        # Reinitialize submodules
        git submodule sync && git submodule update -q --init --recursive

        # conda must be added to the path for Anaconda builds (this location must be
        # the same as that in install_anaconda.sh used to build the docker image)
        if [[ "${BUILD_ENVIRONMENT}" == conda* ]]; then
          export PATH=/opt/conda/bin:$PATH
          sudo chown -R jenkins:jenkins '/opt/conda'
        fi

        # Build
        ./.jenkins/caffe2/build.sh

        # Show sccache stats if it is running
        if pgrep sccache > /dev/null; then
          sccache --show-stats
        fi
        # =================== The above code will be executed inside Docker container ===================
        EOL
        chmod +x /home/circleci/project/ci_build_script.sh

        echo "DOCKER_IMAGE: "${DOCKER_IMAGE}
        docker pull ${DOCKER_IMAGE} >/dev/null
        export id=$(docker run -t -d -w /var/lib/jenkins ${DOCKER_IMAGE})
        docker cp /home/circleci/project/. $id:/var/lib/jenkins/workspace

        export COMMAND='((echo "source ./workspace/env" && echo "sudo chown -R jenkins workspace && cd workspace && ./ci_build_script.sh") | docker exec -u jenkins -i "$id" bash) 2>&1'
        echo ${COMMAND} > ./command.sh && unbuffer bash ./command.sh | ts

        # Push intermediate Docker image for next phase to use
        if [ -z "${BUILD_ONLY}" ]; then
          if [[ "$BUILD_ENVIRONMENT" == *cmake* ]]; then
            export COMMIT_DOCKER_IMAGE=${DOCKER_IMAGE}-cmake-${CIRCLE_SHA1}
          else
            export COMMIT_DOCKER_IMAGE=${DOCKER_IMAGE}-${CIRCLE_SHA1}
          fi
          docker commit "$id" ${COMMIT_DOCKER_IMAGE}
          docker push ${COMMIT_DOCKER_IMAGE}
        fi

caffe2_linux_test_defaults: &caffe2_linux_test_defaults
  machine:
    image: default
  steps:
  - run:
      <<: *setup_ci_environment
  - run:
      name: Test
      no_output_timeout: "1h"
      command: |
        set -e
        # TODO: merge this into Caffe2 test.sh
        cat >/home/circleci/project/ci_test_script.sh <<EOL
        # =================== The following code will be executed inside Docker container ===================
        set -ex

        export BUILD_ENVIRONMENT="$BUILD_ENVIRONMENT"

        # libdc1394 (dependency of OpenCV) expects /dev/raw1394 to exist...
        sudo ln /dev/null /dev/raw1394

        # conda must be added to the path for Anaconda builds (this location must be
        # the same as that in install_anaconda.sh used to build the docker image)
        if [[ "${BUILD_ENVIRONMENT}" == conda* ]]; then
          export PATH=/opt/conda/bin:$PATH
        fi

        # Upgrade SSL module to avoid old SSL warnings
        pip -q install --user --upgrade pyOpenSSL ndg-httpsclient pyasn1

        pip -q install --user -b /tmp/pip_install_onnx "file:///var/lib/jenkins/workspace/third_party/onnx#egg=onnx"

        # Build
        ./.jenkins/caffe2/test.sh

        # Remove benign core dumps.
        # These are tests for signal handling (including SIGABRT).
        rm -f ./crash/core.fatal_signal_as.*
        rm -f ./crash/core.logging_test.*
        # =================== The above code will be executed inside Docker container ===================
        EOL
        chmod +x /home/circleci/project/ci_test_script.sh

        if [[ "$BUILD_ENVIRONMENT" == *cmake* ]]; then
          export COMMIT_DOCKER_IMAGE=${DOCKER_IMAGE}-cmake-${CIRCLE_SHA1}
        else
          export COMMIT_DOCKER_IMAGE=${DOCKER_IMAGE}-${CIRCLE_SHA1}
        fi
        echo "DOCKER_IMAGE: "${COMMIT_DOCKER_IMAGE}
        docker pull ${COMMIT_DOCKER_IMAGE} >/dev/null
        if [ -n "${CUDA_VERSION}" ]; then
          export id=$(docker run --runtime=nvidia -t -d -w /var/lib/jenkins ${COMMIT_DOCKER_IMAGE})
        else
          export id=$(docker run -t -d -w /var/lib/jenkins ${COMMIT_DOCKER_IMAGE})
        fi
        docker cp /home/circleci/project/. "$id:/var/lib/jenkins/workspace"

        export COMMAND='((echo "source ./workspace/env" && echo "sudo chown -R jenkins workspace && cd workspace && ./ci_test_script.sh") | docker exec -u jenkins -i "$id" bash) 2>&1'
        echo ${COMMAND} > ./command.sh && unbuffer bash ./command.sh | ts


##############################################################################
# Macos build defaults
##############################################################################

caffe2_macos_build_defaults: &caffe2_macos_build_defaults
  macos:
    xcode: "9.0"
  steps:
    - checkout
    - run:
        name: Build
        no_output_timeout: "1h"
        command: |
          set -e

          export IN_CIRCLECI=1

          brew update
          # moreutils installs a `parallel` executable by default, which conflicts with the executable from the GNU `parallel`
          # so we must unlink GNU `parallel` first, and relink it afterwards
          brew unlink parallel
          brew install moreutils --without-parallel
          brew link parallel --overwrite
          brew install cmake
          brew install expect

          # Reinitialize submodules
          git submodule sync && git submodule update -q --init --recursive

          # Reinitialize path (see man page for path_helper(8))
          eval `/usr/libexec/path_helper -s`

          # Use Homebrew Python if configured to do so
          if [ "${PYTHON_INSTALLATION}" == "homebrew" ]; then
            export PATH=/usr/local/opt/python/libexec/bin:/usr/local/bin:$PATH
          fi

          pip -q install numpy

          # Install Anaconda if we need to
          if [ -n "${CAFFE2_USE_ANACONDA}" ]; then
            rm -rf ${TMPDIR}/anaconda
            curl -o ${TMPDIR}/anaconda.sh https://repo.continuum.io/miniconda/Miniconda${ANACONDA_VERSION}-latest-MacOSX-x86_64.sh
            /bin/bash ${TMPDIR}/anaconda.sh -b -p ${TMPDIR}/anaconda
            rm -f ${TMPDIR}/anaconda.sh
            export PATH="${TMPDIR}/anaconda/bin:${PATH}"
            source ${TMPDIR}/anaconda/bin/activate
          fi

          # Install sccache
          sudo curl https://s3.amazonaws.com/ossci-macos/sccache --output /usr/local/bin/sccache
          sudo chmod +x /usr/local/bin/sccache
          export SCCACHE_BUCKET=ossci-compiler-cache-circleci-v2

          # This IAM user allows write access to S3 bucket for sccache
          export AWS_ACCESS_KEY_ID=${CIRCLECI_AWS_ACCESS_KEY_FOR_SCCACHE_S3_BUCKET_V3}
          export AWS_SECRET_ACCESS_KEY=${CIRCLECI_AWS_SECRET_KEY_FOR_SCCACHE_S3_BUCKET_V3}

          export SCCACHE_BIN=${PWD}/sccache_bin
          mkdir -p ${SCCACHE_BIN}
          if which sccache > /dev/null; then
            printf "#!/bin/sh\nexec sccache $(which clang++) \$*" > "${SCCACHE_BIN}/clang++"
            chmod a+x "${SCCACHE_BIN}/clang++"

            printf "#!/bin/sh\nexec sccache $(which clang) \$*" > "${SCCACHE_BIN}/clang"
            chmod a+x "${SCCACHE_BIN}/clang"

            export PATH="${SCCACHE_BIN}:$PATH"
          fi

          # Build
          if [ "${BUILD_IOS:-0}" -eq 1 ]; then
            unbuffer scripts/build_ios.sh 2>&1 | ts
          elif [ -n "${CAFFE2_USE_ANACONDA}" ]; then
            # All conda build logic should be in scripts/build_anaconda.sh
            unbuffer scripts/build_anaconda.sh 2>&1 | ts
          else
            unbuffer scripts/build_local.sh 2>&1 | ts
          fi

          # Show sccache stats if it is running
          if which sccache > /dev/null; then
            sccache --show-stats
          fi



##############################################################################
# Nighlty build smoke tests defaults
##############################################################################

binary_populate_env: &binary_populate_env
  name: Set up env
  command: |
    set -ex

    # Set package_type, py_ver, and cu_ver, and maybe libtorch_type
    if [[ "$PACKAGE_TYPE" == conda ]]; then
      docker_image="soumith/conda-cuda"
    elif [[ "$DESIRED_CUDA" == cpu ]]; then
      docker_image="soumith/manylinux-cuda80"
    else
      docker_image="soumith/manylinux-cuda${DESIRED_CUDA:2}"
    fi

    cat >/home/circleci/project/env <<EOL
    # =================== The following code will be executed inside Docker container ===================
    export DATE=today
    export NIGHTLIES_DATE_PREAMBLE=1.0.0.dev
    export PIP_UPLOAD_FOLDER='nightly/'
    export CIRCLE_TAG="$CIRCLE_TAG"
    export CIRCLE_SHA1="$CIRCLE_SHA1"
    export CIRCLE_PR_NUMBER="$CIRCLE_PR_NUMBER"
    export CIRCLE_BRANCH="$CIRCLE_BRANCH"
    export PACKAGE_TYPE="$PACKAGE_TYPE"
    export DESIRED_PYTHON="$DESIRED_PYTHON"
    export DESIRED_CUDA="$DESIRED_CUDA"
    export LIBTORCH_VARIANT="$LIBTORCH_VARIANT"
    export DOCKER_IMAGE="$docker_image"
    # =================== The above code will be executed inside Docker container ===================
    EOL

    echo 'retry () {' >> /home/circleci/project/env
    echo '    $*  || (sleep 1 && $*) || (sleep 2 && $*) || (sleep 4 && $*) || (sleep 8 && $*)' >> /home/circleci/project/env
    echo '}' >> /home/circleci/project/env
    echo 'export -f retry' >> /home/circleci/project/env

# This section is used in the binary_test and smoke_test jobs. It expects
# 'binary_populate_env' to have populated /home/circleci/project/env and it
# expects another section to populate /home/circleci/project/ci_test_script.sh
# with the code to run in the docker
binary_run_in_docker: &binary_run_in_docker
  name: Run in docker
  command: |
    # Expect all needed environment variables to be written to this file
    source /home/circleci/project/env
    set -ex

    # Expect actual code to be written to this file
    chmod +x /home/circleci/project/ci_test_script.sh

    # Run the docker and copy pkgs/env/script into it
    if [ -n "${CUDA_VERSION}" ]; then
      export id=$(docker run --runtime=nvidia -t -d "${DOCKER_IMAGE}")
    else
      export id=$(docker run -t -d "${DOCKER_IMAGE}")
    fi
    docker cp /home/circleci/project/. "$id:/circleci_stuff"
    if [[ -d "/home/circleci/project/final_pkgs" ]]; then
      docker cp /home/circleci/project/final_pkgs "$id:/final_pkgs"
    fi

    # Execute the test script that was populated by an earlier section
    export COMMAND='((echo "source /circleci_stuff/env && /circleci_stuff/ci_test_script.sh") | docker exec -i "$id" bash) 2>&1'
    echo ${COMMAND} > ./command.sh && unbuffer bash ./command.sh | ts

# These are the second-round smoke tests. These make sure that the binaries are
# correct from a user perspective, testing that they exist from the cloud are
# are runnable. Note that the pytorch repo is never cloned into these jobs
smoke_linux_build: &smoke_linux_build
  machine:
    image: default
  steps:
  - run:
      <<: *install_official_git_client
  - run:
      <<: *setup_ci_environment
  - run:
      <<: *binary_populate_env
  - run:
      name: Test
      no_output_timeout: "1h"
      command: |
        set -ex
        cat >/home/circleci/project/ci_test_script.sh <<EOL
        # The following code will be executed inside Docker container
        set -ex
        git clone https://github.com/pytorch/builder.git /builder
        /builder/smoke_test.sh
        # The above code will be executed inside Docker container
        EOL
  - run:
      <<: *binary_run_in_docker


smoke_mac_build: &smoke_mac_build
  macos:
    xcode: "9.0"
  steps:
    - run:
        name: Build
        no_output_timeout: "1h"
        command: |
          set -ex
          export DATE=today
          export NIGHTLIES_DATE_PREAMBLE=1.0.0.dev
          # moreutils installs a `parallel` executable by default, which conflicts with the executable from the GNU `parallel`
          # so we must unlink GNU `parallel` first, and relink it afterwards
          brew update
          brew unlink parallel
          brew install moreutils --without-parallel
          brew link parallel --overwrite
          brew install expect
          git clone https://github.com/pytorch/builder.git
          unbuffer ./builder/smoke_test.sh | ts

##############################################################################
# Binary build (nightlies nightly build) defaults
# The binary builds use the docker executor b/c at time of writing the machine
# executor is limited to only two cores and is painfully slow (4.5+ hours per
# GPU build). But the docker executor cannot be run with --runtime=nvidia, and
# so the binary test/upload jobs must run on a machine executor. The package
# built in the build job is persisted to the workspace, which the test jobs
# expect. The test jobs just run a few quick smoke tests (very similar to the
# second-round-user-facing smoke tests above) and then upload the binaries to
# their final locations. The upload part requires credentials that should only
# be available to org-members.
##############################################################################
binary_linux_build: &binary_linux_build
  resource_class: 2xlarge+
  steps:
  - run:
      name: Checkout
      no_output_timeout: "1h"
      command: |
        set -ex
        cd /

        # Clone the Pytorch branch
        git clone https://github.com/pytorch/pytorch.git /pytorch
        pushd /pytorch
        if [[ -n "$CIRCLE_PR_NUMBER" ]]; then
          # "smoke" binary build on PRs
          git fetch --force origin "pull/${CIRCLE_PR_NUMBER}/head:remotes/origin/pull/${CIRCLE_PR_NUMBER}"
          git reset --hard "$CIRCLE_SHA1"
          git checkout -q -B "$CIRCLE_BRANCH"
          git reset --hard "$CIRCLE_SHA1"
        fi
        git submodule update --init --recursive
        popd

        # Clone the Builder master repo
        git clone -q https://github.com/pytorch/builder.git /builder
  - run:
      name: Build
      no_output_timeout: "1h"
      command: |
        set -ex
        # Defaults here so they can be changed in one place
        export TORCH_PACKAGE_NAME='torch-nightly'
        export TORCH_CONDA_BUILD_FOLDER='pytorch-nightly'
        export PIP_UPLOAD_FOLDER='nightly/'
        export NO_FBGEMM=1
        export PYTORCH_FINAL_PACKAGE_DIR='/final_pkgs'
        export PYTORCH_BUILD_VERSION="1.0.0.dev$(date +%Y%m%d)"
        export PYTORCH_BUILD_NUMBER=1
        export OVERRIDE_PACKAGE_VERSION="$PYTORCH_BUILD_VERSION"
        export MAX_JOBS=12

        echo "RUNNING ON $(uname -a) WITH $(nproc) CPUS AND $(free -m)"

        # Parse the parameters
        if [[ "$PACKAGE_TYPE" == libtorch ]]; then
          export BUILD_PYTHONLESS=1
        fi
        if [[ "$PACKAGE_TYPE" == 'conda' ]]; then
          build_script='conda/build_pytorch.sh'
        elif [[ "$DESIRED_CUDA" == cpu ]]; then
          build_script='manywheel/build_cpu.sh'
        else
          build_script='manywheel/build.sh'
        fi

        # Build the package
        SKIP_ALL_TESTS=1 "/builder/$build_script"
  - persist_to_workspace:
      root: /
      paths: final_pkgs

binary_linux_test_and_upload: &binary_linux_test_and_upload
  machine:
    image: default
  steps:
  - run:
      <<: *setup_ci_environment
  - attach_workspace:
      at: /home/circleci/project
  - run:
      <<: *binary_populate_env
  - run:
      name: Test
      no_output_timeout: "1h"
      command: |
        source /home/circleci/project/env
        echo "declare -x \"AWS_ACCESS_KEY_ID=${PYTORCH_BINARY_AWS_ACCESS_KEY_ID}\"" >> /home/circleci/project/env
        echo "declare -x \"AWS_SECRET_ACCESS_KEY=${PYTORCH_BINARY_AWS_SECRET_ACCESS_KEY}\"" >> /home/circleci/project/env
        echo "declare -x \"CONDA_USERNAME=${PYTORCH_BINARY_PJH5_CONDA_USERNAME}\"" >> /home/circleci/project/env
        echo "declare -x \"CONDA_PASSWORD=${PYTORCH_BINARY_PJH5_CONDA_PASSWORD}\"" >> /home/circleci/project/env
        set -ex

        # Expects pkg to be in /final_pkgs in the docker

        # The variables in the code block below are evaluated at time of `cat`,
        # so we must declare all new variables now
        python_nodot="$(echo $DESIRED_PYTHON | tr -d m.u)"
        pkg="/final_pkgs/$(ls /home/circleci/project/final_pkgs)"
        CONDA_USERNAME='$CONDA_USERNAME'
        CONDA_PASSWORD='$CONDA_PASSWORD'
        if [[ "$PACKAGE_TYPE" == libtorch ]]; then
          s3_dir="s3://pytorch/libtorch/${PIP_UPLOAD_FOLDER}${DESIRED_CUDA}/"
        else
          s3_dir="s3://pytorch/whl/${PIP_UPLOAD_FOLDER}${DESIRED_CUDA}/"
        fi

        cat >/home/circleci/project/ci_test_script.sh <<EOL
        # =================== The following code will be executed inside Docker container ===================
        set -ex

        # Clone the Pytorch branch
        git clone https://github.com/pytorch/pytorch.git /pytorch
        pushd /pytorch
        if [[ -n "$CIRCLE_PR_NUMBER" ]]; then
          # "smoke" binary build on PRs
          git fetch --force origin "pull/${CIRCLE_PR_NUMBER}/head:remotes/origin/pull/${CIRCLE_PR_NUMBER}"
          git reset --hard "$CIRCLE_SHA1"
          git checkout -q -B "$CIRCLE_BRANCH"
          git reset --hard "$CIRCLE_SHA1"
        fi
        git submodule update --init --recursive
        popd

        # Clone the Builder master repo
        git clone -q https://github.com/pytorch/builder.git /builder

        # Set up Python
        if [[ "$PACKAGE_TYPE" == manywheel ]]; then
          if [[ "$DESIRED_PYTHON" == '2.7mu' ]]; then
            export PATH="/opt/python/cp27-cp27mu/bin:$PATH"
          else
            export PATH="/opt/python/cp${python_nodot}-cp${python_nodot}m/bin:$PATH"
          fi
        else
          retry conda create -qyn testenv python=$DESIRED_PYTHON
          source activate testenv
        fi

        # Install the package
        if [[ "$PACKAGE_TYPE" == conda ]]; then
          conda install -y "$pkg" --offline --no-update-dependencies
        else
          pip install "$pkg"
        fi

        # Test the package
        pushd /pytorch
        /builder/run_tests.sh "$PACKAGE_TYPE" "$DESIRED_PYTHON" "$DESIRED_CUDA"

        # Upload the package to the final location
        if [[ -z "DO_NOT_UPLOAD" ]]; then
          if [[ "$PACKAGE_TYPE" == conda ]]; then
            retry conda install -yq anaconda-client
            yes | anaconda login --username "$CONDA_USERNAME" --password "$CONDA_PASSWORD"
            anaconda upload "$pkg" -u pytorch --label main --no-progress
          elif [[ "$PACKAGE_TYPE" == libtorch ]]; then
            retry pip install -q awscli
            retry aws s3 cp "$pkg" "$s3_dir" --acl public-read
          else
            retry pip install -q awscli
            retry aws s3 cp "$pkg" "$s3_dir" --acl public-read
          fi
        fi
        # =================== The above code will be executed inside Docker container ===================
        EOL
  - run:
      <<: *binary_run_in_docker


binary_mac_build: &binary_mac_build
  macos:
    xcode: "9.0"
  steps:
    - run:
        name: Build
        no_output_timeout: "1h"
        command: |
          set -ex
          # moreutils installs a `parallel` executable by default, which conflicts with the executable from the GNU `parallel`
          # so we must unlink GNU `parallel` first, and relink it afterwards
          brew update
          brew unlink parallel
          brew install moreutils --without-parallel
          brew link parallel --overwrite
          brew install expect

          # Default parameters in one place so they're easy to change
          export PYTORCH_REPO='pytorch'
          export PYTORCH_BRANCH='master'
          export TORCH_PACKAGE_NAME='torch-nightly'
          export PYTORCH_BUILD_VERSION="1.0.0.dev$(date +%Y%m%d)"
          export PYTORCH_BUILD_NUMBER=1
          export TORCH_CONDA_BUILD_FOLDER="pytorch-nightly"
          #export OVERRIDE_PACKAGE_VERSION="some_version.123"

          # Job parameters
          if [[ "$PACKAGE_TYPE" == 'libtorch' ]]; then
            export BUILD_PYTHONLESS=1
          fi

          git clone https://github.com/pytorch/builder.git
          if [[ "$PACKAGE_TYPE" == conda ]]; then
            unbuffer ./builder/conda/build_pytorch.sh | ts
          else
            export TORCH_PACKAGE_NAME="$(echo $TORCH_PACKAGE_NAME | tr '-' '_')"
            unbuffer ./builder/wheel/build_wheel.sh | ts
          fi



##############################################################################
##############################################################################
# Job specifications job specs
##############################################################################
##############################################################################
version: 2
jobs:
  pytorch_linux_trusty_py2_7_9_build:
    environment:
      JOB_BASE_NAME: pytorch-linux-trusty-py2.7.9-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py2.7.9:282"
    <<: *pytorch_linux_build_defaults

  pytorch_linux_trusty_py2_7_9_test:
    environment:
      JOB_BASE_NAME: pytorch-linux-trusty-py2.7.9-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py2.7.9:282"
    resource_class: large
    <<: *pytorch_linux_test_defaults

  pytorch_linux_trusty_py2_7_build:
    environment:
      JOB_BASE_NAME: pytorch-linux-trusty-py2.7-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py2.7:282"
    <<: *pytorch_linux_build_defaults

  pytorch_linux_trusty_py2_7_test:
    environment:
      JOB_BASE_NAME: pytorch-linux-trusty-py2.7-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py2.7:282"
    resource_class: large
    <<: *pytorch_linux_test_defaults

  pytorch_linux_trusty_py3_5_build:
    environment:
      JOB_BASE_NAME: pytorch-linux-trusty-py3.5-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py3.5:282"
    <<: *pytorch_linux_build_defaults

  pytorch_linux_trusty_py3_5_test:
    environment:
      JOB_BASE_NAME: pytorch-linux-trusty-py3.5-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py3.5:282"
    resource_class: large
    <<: *pytorch_linux_test_defaults

  pytorch_linux_trusty_py3_6_gcc4_8_build:
    environment:
      JOB_BASE_NAME: pytorch-linux-trusty-py3.6-gcc4.8-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py3.6-gcc4.8:282"
    <<: *pytorch_linux_build_defaults

  pytorch_linux_trusty_py3_6_gcc4_8_test:
    environment:
      JOB_BASE_NAME: pytorch-linux-trusty-py3.6-gcc4.8-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py3.6-gcc4.8:282"
    resource_class: large
    <<: *pytorch_linux_test_defaults

  pytorch_linux_trusty_py3_6_gcc5_4_build:
    environment:
      JOB_BASE_NAME: pytorch-linux-trusty-py3.6-gcc5.4-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py3.6-gcc5.4:282"
    <<: *pytorch_linux_build_defaults

  pytorch_linux_trusty_py3_6_gcc5_4_test:
    environment:
      JOB_BASE_NAME: pytorch-linux-trusty-py3.6-gcc5.4-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py3.6-gcc5.4:282"
    resource_class: large
    <<: *pytorch_linux_test_defaults

  pytorch_linux_trusty_py3_6_gcc7_build:
    environment:
      JOB_BASE_NAME: pytorch-linux-trusty-py3.6-gcc7-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py3.6-gcc7:282"
    <<: *pytorch_linux_build_defaults

  pytorch_linux_trusty_py3_6_gcc7_test:
    environment:
      JOB_BASE_NAME: pytorch-linux-trusty-py3.6-gcc7-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-py3.6-gcc7:282"
    resource_class: large
    <<: *pytorch_linux_test_defaults

  pytorch_linux_trusty_pynightly_build:
    environment:
      JOB_BASE_NAME: pytorch-linux-trusty-pynightly-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-pynightly:282"
    <<: *pytorch_linux_build_defaults

  pytorch_linux_trusty_pynightly_test:
    environment:
      JOB_BASE_NAME: pytorch-linux-trusty-pynightly-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-trusty-pynightly:282"
    resource_class: large
    <<: *pytorch_linux_test_defaults

  pytorch_linux_xenial_py3_clang5_asan_build:
    environment:
      JOB_BASE_NAME: pytorch-linux-xenial-py3-clang5-asan-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-py3-clang5-asan:282"
      PYTHON_VERSION: "3.6"
    <<: *pytorch_linux_build_defaults

  pytorch_linux_xenial_py3_clang5_asan_test:
    environment:
      JOB_BASE_NAME: pytorch-linux-xenial-py3-clang5-asan-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-py3-clang5-asan:282"
      PYTHON_VERSION: "3.6"
    resource_class: large
    <<: *pytorch_linux_test_defaults

  pytorch_linux_xenial_cuda8_cudnn7_py3_build:
    environment:
      JOB_BASE_NAME: pytorch-linux-xenial-cuda8-cudnn7-py3-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda8-cudnn7-py3:282"
      PYTHON_VERSION: "3.6"
      CUDA_VERSION: "8"
      BUILD_ENVIRONMENT: "pytorch-linux-xenial-cuda8-cudnn7-py3"
    <<: *pytorch_linux_build_defaults

  pytorch_linux_xenial_cuda8_cudnn7_py3_test:
    environment:
      JOB_BASE_NAME: pytorch-linux-xenial-cuda8-cudnn7-py3-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda8-cudnn7-py3:282"
      PYTHON_VERSION: "3.6"
      CUDA_VERSION: "8"
    resource_class: gpu.medium
    <<: *pytorch_linux_test_defaults

  pytorch_linux_xenial_cuda8_cudnn7_py3_multigpu_test:
    environment:
      JOB_BASE_NAME: pytorch-linux-xenial-cuda8-cudnn7-py3-multigpu-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda8-cudnn7-py3:282"
      PYTHON_VERSION: "3.6"
      CUDA_VERSION: "8"
      MULTI_GPU: "1"
    resource_class: gpu.large
    <<: *pytorch_linux_test_defaults

  pytorch_linux_xenial_cuda8_cudnn7_py3_NO_AVX2_test:
    environment:
      JOB_BASE_NAME: pytorch-linux-xenial-cuda8-cudnn7-py3-NO_AVX2-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda8-cudnn7-py3:282"
      PYTHON_VERSION: "3.6"
      CUDA_VERSION: "8"
    resource_class: gpu.medium
    <<: *pytorch_linux_test_defaults

  pytorch_linux_xenial_cuda8_cudnn7_py3_NO_AVX_NO_AVX2_test:
    environment:
      JOB_BASE_NAME: pytorch-linux-xenial-cuda8-cudnn7-py3-NO_AVX-NO_AVX2-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda8-cudnn7-py3:282"
      PYTHON_VERSION: "3.6"
      CUDA_VERSION: "8"
    resource_class: gpu.medium
    <<: *pytorch_linux_test_defaults

  pytorch_linux_xenial_cuda9_cudnn7_py2_build:
    environment:
      JOB_BASE_NAME: pytorch-linux-xenial-cuda9-cudnn7-py2-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda9-cudnn7-py2:282"
      PYTHON_VERSION: "2.7"
      CUDA_VERSION: "9"
    <<: *pytorch_linux_build_defaults

  pytorch_linux_xenial_cuda9_cudnn7_py2_test:
    environment:
      JOB_BASE_NAME: pytorch-linux-xenial-cuda9-cudnn7-py2-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda9-cudnn7-py2:282"
      PYTHON_VERSION: "2.7"
      CUDA_VERSION: "9"
    resource_class: gpu.medium
    <<: *pytorch_linux_test_defaults

  pytorch_linux_xenial_cuda9_cudnn7_py3_build:
    environment:
      JOB_BASE_NAME: pytorch-linux-xenial-cuda9-cudnn7-py3-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda9-cudnn7-py3:282"
      PYTHON_VERSION: "3.6"
      CUDA_VERSION: "9"
    <<: *pytorch_linux_build_defaults

  pytorch_linux_xenial_cuda9_cudnn7_py3_test:
    environment:
      JOB_BASE_NAME: pytorch-linux-xenial-cuda9-cudnn7-py3-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda9-cudnn7-py3:282"
      PYTHON_VERSION: "3.6"
      CUDA_VERSION: "9"
    resource_class: gpu.medium
    <<: *pytorch_linux_test_defaults

  pytorch_linux_xenial_cuda9_2_cudnn7_py3_gcc7_build:
    environment:
      JOB_BASE_NAME: pytorch-linux-xenial-cuda9.2-cudnn7-py3-gcc7-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda9.2-cudnn7-py3-gcc7:282"
      PYTHON_VERSION: "3.6"
      CUDA_VERSION: "9.2"
    <<: *pytorch_linux_build_defaults

  pytorch_linux_xenial_cuda9_2_cudnn7_py3_gcc7_test:
    environment:
      JOB_BASE_NAME: pytorch-linux-xenial-cuda9.2-cudnn7-py3-gcc7-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda9.2-cudnn7-py3-gcc7:282"
      PYTHON_VERSION: "3.6"
      CUDA_VERSION: "9.2"
    resource_class: gpu.medium
    <<: *pytorch_linux_test_defaults

  pytorch_linux_xenial_cuda10_cudnn7_py3_gcc7_build:
    environment:
      JOB_BASE_NAME: pytorch-linux-xenial-cuda10-cudnn7-py3-gcc7-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda10-cudnn7-py3-gcc7:282"
      PYTHON_VERSION: "3.6"
      CUDA_VERSION: "10"
    <<: *pytorch_linux_build_defaults

  pytorch_short_perf_test_gpu:
    environment:
      JOB_BASE_NAME: pytorch-short-perf-test-gpu
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda8-cudnn7-py3:282"
      PYTHON_VERSION: "3.6"
      CUDA_VERSION: "8"
    resource_class: gpu.medium
    machine:
      image: default
    steps:
    - run:
        <<: *setup_ci_environment
    - run:
        name: Perf Test
        no_output_timeout: "1h"
        command: |
          set -e
          export COMMIT_DOCKER_IMAGE=${DOCKER_IMAGE}-${CIRCLE_SHA1}
          echo "DOCKER_IMAGE: "${COMMIT_DOCKER_IMAGE}
          docker pull ${COMMIT_DOCKER_IMAGE} >/dev/null
          export id=$(docker run --runtime=nvidia -t -d -w /var/lib/jenkins ${COMMIT_DOCKER_IMAGE})

          docker cp $id:/var/lib/jenkins/workspace/env /home/circleci/project/env
          # This IAM user allows write access to S3 bucket for perf test numbers
          echo "declare -x AWS_ACCESS_KEY_ID=${CIRCLECI_AWS_ACCESS_KEY_FOR_PERF_TEST_S3_BUCKET_V3}" >> /home/circleci/project/env
          echo "declare -x AWS_SECRET_ACCESS_KEY=${CIRCLECI_AWS_SECRET_KEY_FOR_PERF_TEST_S3_BUCKET_V3}" >> /home/circleci/project/env
          docker cp /home/circleci/project/env $id:/var/lib/jenkins/workspace/env

          export COMMAND='((echo "export JOB_BASE_NAME=${JOB_BASE_NAME}" && echo "source ./workspace/env" && echo "sudo chown -R jenkins workspace && cd workspace && .jenkins/pytorch/short-perf-test-gpu.sh") | docker exec -u jenkins -i "$id" bash) 2>&1'
          echo ${COMMAND} > ./command.sh && unbuffer bash ./command.sh | ts

  pytorch_doc_push:
    environment:
      JOB_BASE_NAME: pytorch-doc-push
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/pytorch/pytorch-linux-xenial-cuda8-cudnn7-py3:282"
    resource_class: large
    machine:
      image: default
    steps:
    - run:
        <<: *setup_ci_environment
    - run:
        name: Doc Push
        no_output_timeout: "1h"
        command: |
          set -e
          if [[ "${CIRCLE_BRANCH}" != "master" ]]; then
            echo "Skipping doc push..."
            exit 0
          fi
          export COMMIT_DOCKER_IMAGE=${DOCKER_IMAGE}-${CIRCLE_SHA1}
          echo "DOCKER_IMAGE: "${COMMIT_DOCKER_IMAGE}
          docker pull ${COMMIT_DOCKER_IMAGE} >/dev/null
          export id=$(docker run -t -d -w /var/lib/jenkins ${COMMIT_DOCKER_IMAGE})

          cat >/home/circleci/project/doc_push_script.sh <<EOL
          # =================== The following code will be executed inside Docker container ===================
          git clone https://yf225:${GITHUB_PYTORCHBOT_TOKEN}@github.com/pytorch/pytorch.github.io -b site
          pushd pytorch.github.io

          set -ex

          export LC_ALL=C
          export PATH=/opt/conda/bin:$PATH

          rm -rf pytorch || true

          # Get all the documentation sources, put them in one place
          # TODO: These clones can race
          git clone https://github.com/pytorch/pytorch
          pushd pytorch
          git clone https://github.com/pytorch/vision
          pushd vision
          conda install -q pillow
          time python setup.py install
          popd
          pushd docs
          rm -rf source/torchvision
          cp -r ../vision/docs/source source/torchvision

          # Build the docs
          pip -q install -r requirements.txt || true
          make html

          # Move them into the docs repo
          popd
          popd
          git rm -rf docs/master || true
          mv pytorch/docs/build/html docs/master
          find docs/master -name "*.html" -print0 | xargs -0 sed -i -E 's/master[[:blank:]]\\([[:digit:]]\\.[[:digit:]]\\.[[:xdigit:]]+\\+[[:xdigit:]]+[[:blank:]]\\)/<a href="http:\\/\\/pytorch.org\\/docs\\/versions.html">& \\&#x25BC<\\/a>/g'
          git add docs/master || true
          git status
          git config user.email "soumith+bot@pytorch.org"
          git config user.name "pytorchbot"
          # If there aren't changes, don't make a commit; push is no-op
          git commit -m "auto-generating sphinx docs" || true
          git status
          git push origin site

          popd
          # =================== The above code will be executed inside Docker container ===================
          EOL
          chmod +x /home/circleci/project/doc_push_script.sh
          docker cp /home/circleci/project/doc_push_script.sh $id:/var/lib/jenkins/workspace/doc_push_script.sh

          export COMMAND='((echo "export JOB_BASE_NAME=${JOB_BASE_NAME}" && echo "source ./workspace/env" && echo "sudo chown -R jenkins workspace && cd workspace && ./doc_push_script.sh") | docker exec -u jenkins -i "$id" bash) 2>&1'
          echo ${COMMAND} > ./command.sh && unbuffer bash ./command.sh | ts

  pytorch_macos_10_13_py3_build:
    macos:
      xcode: "9.0"
    steps:
      - checkout
      - run:
          name: Build
          environment:
            JOB_BASE_NAME: pytorch-macos-10.13-py3-build
            BUILD_ENVIRONMENT: pytorch-macos-10.13-py3
          no_output_timeout: "1h"
          command: |
            set -e

            export IN_CIRCLECI=1

            brew update
            # moreutils installs a `parallel` executable by default, which conflicts with the executable from the GNU `parallel`
            # so we must unlink GNU `parallel` first, and relink it afterwards
            brew unlink parallel
            brew install moreutils --without-parallel
            brew link parallel --overwrite
            brew install expect

            # Install sccache
            sudo curl https://s3.amazonaws.com/ossci-macos/sccache --output /usr/local/bin/sccache
            sudo chmod +x /usr/local/bin/sccache

            export SCCACHE_BUCKET=ossci-compiler-cache-circleci-v2
            # This IAM user allows write access to S3 bucket for sccache
            export AWS_ACCESS_KEY_ID=${CIRCLECI_AWS_ACCESS_KEY_FOR_SCCACHE_S3_BUCKET_V3}
            export AWS_SECRET_ACCESS_KEY=${CIRCLECI_AWS_SECRET_KEY_FOR_SCCACHE_S3_BUCKET_V3}

            git submodule sync && git submodule update -q --init
            chmod a+x .jenkins/pytorch/macos-build.sh
            unbuffer .jenkins/pytorch/macos-build.sh 2>&1 | ts

            mkdir -p /Users/distiller/pytorch-ci-env/workspace
            cp -r /Users/distiller/project/. /Users/distiller/pytorch-ci-env/workspace
      - persist_to_workspace:
          root: /Users/distiller/pytorch-ci-env
          paths:
            - "*"

  pytorch_macos_10_13_py3_test:
    macos:
      xcode: "9.0"
    steps:
      - run:
          name: Prepare workspace
          command: |
            sudo mkdir -p /Users/distiller/pytorch-ci-env
            sudo chmod -R 777 /Users/distiller/pytorch-ci-env
      - attach_workspace:
          at: /Users/distiller/pytorch-ci-env
      - run:
          name: Test
          environment:
            JOB_BASE_NAME: pytorch-macos-10.13-py3-test
            BUILD_ENVIRONMENT: pytorch-macos-10.13-py3
          no_output_timeout: "1h"
          command: |
            set -e
            export IN_CIRCLECI=1

            brew update
            # moreutils installs a `parallel` executable by default, which conflicts with the executable from the GNU `parallel`
            # so we must unlink GNU `parallel` first, and relink it afterwards
            brew unlink parallel
            brew install moreutils --without-parallel
            brew link parallel --overwrite
            brew install expect

            cp -r /Users/distiller/pytorch-ci-env/workspace/. /Users/distiller/project

            chmod a+x .jenkins/pytorch/macos-test.sh
            unbuffer .jenkins/pytorch/macos-test.sh 2>&1 | ts

  pytorch_macos_10_13_cuda9_2_cudnn7_py3_build:
    macos:
      xcode: "9.0"
    steps:
      - checkout
      - run:
          name: Build
          environment:
            JOB_BASE_NAME: pytorch-macos-10.13-cuda9.2-cudnn7-py3-build
            BUILD_ENVIRONMENT: pytorch-macos-10.13-cuda9.2-cudnn7-py3
          no_output_timeout: "1h"
          command: |
            set -e

            export IN_CIRCLECI=1

            brew update
            # moreutils installs a `parallel` executable by default, which conflicts with the executable from the GNU `parallel`
            # so we must unlink GNU `parallel` first, and relink it afterwards
            brew unlink parallel
            brew install moreutils --without-parallel
            brew link parallel --overwrite
            brew install expect

            # Install CUDA 9.2
            sudo rm -rf ~/cuda_9.2.64_mac_installer.app || true
            curl https://s3.amazonaws.com/ossci-macos/cuda_9.2.64_mac_installer.zip -o ~/cuda_9.2.64_mac_installer.zip
            unzip ~/cuda_9.2.64_mac_installer.zip -d ~/
            sudo ~/cuda_9.2.64_mac_installer.app/Contents/MacOS/CUDAMacOSXInstaller --accept-eula --no-window
            sudo cp /usr/local/cuda/lib/libcuda.dylib /Developer/NVIDIA/CUDA-9.2/lib/libcuda.dylib
            sudo rm -rf /usr/local/cuda || true

            # Install cuDNN 7.1 for CUDA 9.2
            curl https://s3.amazonaws.com/ossci-macos/cudnn-9.2-osx-x64-v7.1.tgz -o ~/cudnn-9.2-osx-x64-v7.1.tgz
            rm -rf ~/cudnn-9.2-osx-x64-v7.1 && mkdir ~/cudnn-9.2-osx-x64-v7.1
            tar -xzvf ~/cudnn-9.2-osx-x64-v7.1.tgz -C ~/cudnn-9.2-osx-x64-v7.1
            sudo cp ~/cudnn-9.2-osx-x64-v7.1/cuda/include/cudnn.h /Developer/NVIDIA/CUDA-9.2/include/
            sudo cp ~/cudnn-9.2-osx-x64-v7.1/cuda/lib/libcudnn* /Developer/NVIDIA/CUDA-9.2/lib/
            sudo chmod a+r /Developer/NVIDIA/CUDA-9.2/include/cudnn.h /Developer/NVIDIA/CUDA-9.2/lib/libcudnn*

            # Install sccache
            sudo curl https://s3.amazonaws.com/ossci-macos/sccache --output /usr/local/bin/sccache
            sudo chmod +x /usr/local/bin/sccache
            export SCCACHE_BUCKET=ossci-compiler-cache-circleci-v2
            # This IAM user allows write access to S3 bucket for sccache
            export AWS_ACCESS_KEY_ID=${CIRCLECI_AWS_ACCESS_KEY_FOR_SCCACHE_S3_BUCKET_V3}
            export AWS_SECRET_ACCESS_KEY=${CIRCLECI_AWS_SECRET_KEY_FOR_SCCACHE_S3_BUCKET_V3}

            git submodule sync && git submodule update -q --init
            chmod a+x .jenkins/pytorch/macos-build.sh
            unbuffer .jenkins/pytorch/macos-build.sh 2>&1 | ts

  caffe2_py2_cuda9_0_cudnn7_ubuntu16_04_build:
    environment:
      JOB_BASE_NAME: caffe2-py2-cuda9.0-cudnn7-ubuntu16.04-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py2-cuda9.0-cudnn7-ubuntu16.04:238"
      CUDA_VERSION: "9"
      BUILD_ENVIRONMENT: "py2-cuda9.0-cudnn7-ubuntu16.04"
    <<: *caffe2_linux_build_defaults

  caffe2_py2_cuda9_0_cudnn7_ubuntu16_04_test:
    environment:
      JOB_BASE_NAME: caffe2-py2-cuda9.0-cudnn7-ubuntu16.04-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py2-cuda9.0-cudnn7-ubuntu16.04:238"
      CUDA_VERSION: "9"
      BUILD_ENVIRONMENT: "py2-cuda9.0-cudnn7-ubuntu16.04"
    resource_class: gpu.medium
    <<: *caffe2_linux_test_defaults

  caffe2_cmake_cuda9_0_cudnn7_ubuntu16_04_build:
    environment:
      JOB_BASE_NAME: caffe2-cmake-cuda9.0-cudnn7-ubuntu16.04-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py2-cuda9.0-cudnn7-ubuntu16.04:238"
      CUDA_VERSION: "9"
      BUILD_ENVIRONMENT: "cmake-cuda9.0-cudnn7-ubuntu16.04"
    <<: *caffe2_linux_build_defaults

  caffe2_cmake_cuda9_0_cudnn7_ubuntu16_04_test:
    environment:
      JOB_BASE_NAME: caffe2-cmake-cuda9.0-cudnn7-ubuntu16.04-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py2-cuda9.0-cudnn7-ubuntu16.04:238"
      CUDA_VERSION: "9"
      BUILD_ENVIRONMENT: "cmake-cuda9.0-cudnn7-ubuntu16.04"
    resource_class: gpu.medium
    <<: *caffe2_linux_test_defaults

  caffe2_py2_cuda9_1_cudnn7_ubuntu16_04_build:
    environment:
      JOB_BASE_NAME: caffe2-py2-cuda9.1-cudnn7-ubuntu16.04-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py2-cuda9.1-cudnn7-ubuntu16.04:238"
      CUDA_VERSION: "9.1"
      BUILD_ENVIRONMENT: "py2-cuda9.1-cudnn7-ubuntu16.04"
    <<: *caffe2_linux_build_defaults

  caffe2_py2_cuda9_1_cudnn7_ubuntu16_04_test:
    environment:
      JOB_BASE_NAME: caffe2-py2-cuda9.1-cudnn7-ubuntu16.04-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py2-cuda9.1-cudnn7-ubuntu16.04:238"
      CUDA_VERSION: "9.1"
      BUILD_ENVIRONMENT: "py2-cuda9.1-cudnn7-ubuntu16.04"
    resource_class: gpu.medium
    <<: *caffe2_linux_test_defaults

  caffe2_py2_mkl_ubuntu16_04_build:
    environment:
      JOB_BASE_NAME: caffe2-py2-mkl-ubuntu16.04-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py2-mkl-ubuntu16.04:238"
      BUILD_ENVIRONMENT: "py2-mkl-ubuntu16.04"
    <<: *caffe2_linux_build_defaults

  caffe2_py2_mkl_ubuntu16_04_test:
    environment:
      JOB_BASE_NAME: caffe2-py2-mkl-ubuntu16.04-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py2-mkl-ubuntu16.04:238"
      BUILD_ENVIRONMENT: "py2-mkl-ubuntu16.04"
    resource_class: large
    <<: *caffe2_linux_test_defaults

  caffe2_py2_gcc4_8_ubuntu14_04_build:
    environment:
      JOB_BASE_NAME: caffe2-py2-gcc4.8-ubuntu14.04-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py2-gcc4.8-ubuntu14.04:238"
      BUILD_ENVIRONMENT: "py2-gcc4.8-ubuntu14.04"
    <<: *caffe2_linux_build_defaults

  caffe2_py2_gcc4_8_ubuntu14_04_test:
    environment:
      JOB_BASE_NAME: caffe2-py2-gcc4.8-ubuntu14.04-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py2-gcc4.8-ubuntu14.04:238"
      BUILD_ENVIRONMENT: "py2-gcc4.8-ubuntu14.04"
    resource_class: large
    <<: *caffe2_linux_test_defaults

  caffe2_onnx_py2_gcc5_ubuntu16_04_build:
    environment:
      JOB_BASE_NAME: caffe2-onnx-py2-gcc5-ubuntu16.04-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py2-gcc5-ubuntu16.04:238"
      BUILD_ENVIRONMENT: "onnx-py2-gcc5-ubuntu16.04"
    <<: *caffe2_linux_build_defaults

  caffe2_onnx_py2_gcc5_ubuntu16_04_test:
    environment:
      JOB_BASE_NAME: caffe2-onnx-py2-gcc5-ubuntu16.04-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py2-gcc5-ubuntu16.04:238"
      BUILD_ENVIRONMENT: "onnx-py2-gcc5-ubuntu16.04"
    resource_class: large
    <<: *caffe2_linux_test_defaults

  caffe2_py2_cuda8_0_cudnn7_ubuntu16_04_build:
    environment:
      JOB_BASE_NAME: caffe2-py2-cuda8.0-cudnn7-ubuntu16.04-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py2-cuda8.0-cudnn7-ubuntu16.04:238"
      CUDA_VERSION: "8"
      BUILD_ENVIRONMENT: "py2-cuda8.0-cudnn7-ubuntu16.04"
    <<: *caffe2_linux_build_defaults

  caffe2_py2_cuda8_0_cudnn7_ubuntu16_04_test:
    environment:
      JOB_BASE_NAME: caffe2-py2-cuda8.0-cudnn7-ubuntu16.04-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py2-cuda8.0-cudnn7-ubuntu16.04:238"
      CUDA_VERSION: "8"
      BUILD_ENVIRONMENT: "py2-cuda8.0-cudnn7-ubuntu16.04"
    resource_class: gpu.medium
    <<: *caffe2_linux_test_defaults

  caffe2_py2_gcc4_9_ubuntu14_04_build:
    environment:
      JOB_BASE_NAME: caffe2-py2-gcc4.9-ubuntu14.04-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py2-gcc4.9-ubuntu14.04:238"
      BUILD_ENVIRONMENT: "py2-gcc4.9-ubuntu14.04"
      BUILD_ONLY: "1"
    <<: *caffe2_linux_build_defaults

  caffe2_py2_clang3_8_ubuntu16_04_build:
    environment:
      JOB_BASE_NAME: caffe2-py2-clang3.8-ubuntu16.04-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py2-clang3.8-ubuntu16.04:238"
      BUILD_ENVIRONMENT: "py2-clang3.8-ubuntu16.04"
      BUILD_ONLY: "1"
    <<: *caffe2_linux_build_defaults

  caffe2_py2_clang3_9_ubuntu16_04_build:
    environment:
      JOB_BASE_NAME: caffe2-py2-clang3.9-ubuntu16.04-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py2-clang3.9-ubuntu16.04:238"
      BUILD_ENVIRONMENT: "py2-clang3.9-ubuntu16.04"
      BUILD_ONLY: "1"
    <<: *caffe2_linux_build_defaults

  caffe2_py2_clang7_ubuntu16_04_build:
    environment:
      JOB_BASE_NAME: caffe2-py2-clang7-ubuntu16.04-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py2-clang7-ubuntu16.04:238"
      BUILD_ENVIRONMENT: "py2-clang7-ubuntu16.04"
      BUILD_ONLY: "1"
    <<: *caffe2_linux_build_defaults

  caffe2_py2_android_ubuntu16_04_build:
    environment:
      JOB_BASE_NAME: caffe2-py2-android-ubuntu16.04-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py2-android-ubuntu16.04:238"
      BUILD_ENVIRONMENT: "py2-android-ubuntu16.04"
      BUILD_ONLY: "1"
    <<: *caffe2_linux_build_defaults

  caffe2_py2_cuda9_0_cudnn7_centos7_build:
    environment:
      JOB_BASE_NAME: caffe2-py2-cuda9.0-cudnn7-centos7-build
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py2-cuda9.0-cudnn7-centos7:238"
      BUILD_ENVIRONMENT: "py2-cuda9.0-cudnn7-centos7"
    <<: *caffe2_linux_build_defaults

  caffe2_py2_cuda9_0_cudnn7_centos7_test:
    environment:
      JOB_BASE_NAME: caffe2-py2-cuda9.0-cudnn7-centos7-test
      DOCKER_IMAGE: "308535385114.dkr.ecr.us-east-1.amazonaws.com/caffe2/py2-cuda9.0-cudnn7-centos7:238"
      CUDA_VERSION: "9.0"
      BUILD_ENVIRONMENT: "py2-cuda9.0-cudnn7-centos7"
    resource_class: gpu.medium
    <<: *caffe2_linux_test_defaults

  caffe2_py2_ios_macos10_13_build:
    environment:
      JOB_BASE_NAME: caffe2-py2-ios-macos10.13-build
      BUILD_IOS: "1"
      PYTHON_INSTALLATION: "system"
      PYTHON_VERSION: "2"
    <<: *caffe2_macos_build_defaults

  caffe2_py2_system_macos10_13_build:
    environment:
      JOB_BASE_NAME: caffe2-py2-system-macos10.13-build
      PYTHON_INSTALLATION: "system"
      PYTHON_VERSION: "2"
    <<: *caffe2_macos_build_defaults



##############################################################################
# Binary build specs individual job specifications
##############################################################################
  binary_linux_manywheel_2.7m_cpu_build:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_linux_manywheel_2.7m_cpu"
    docker:
      - image: "soumith/manylinux-cuda80"
    <<: *binary_linux_build

  binary_linux_manywheel_2.7mu_cpu_build:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "2.7mu"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_linux_manywheel_2.7mu_cpu"
    docker:
      - image: "soumith/manylinux-cuda80"
    <<: *binary_linux_build

  binary_linux_manywheel_3.5m_cpu_build:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.5m"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_linux_manywheel_3.5m_cpu"
    docker:
      - image: "soumith/manylinux-cuda80"
    <<: *binary_linux_build

  binary_linux_manywheel_3.6m_cpu_build:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.6m"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_linux_manywheel_3.6m_cpu"
    docker:
      - image: "soumith/manylinux-cuda80"
    <<: *binary_linux_build

  binary_linux_manywheel_3.7m_cpu_build:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.7m"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_linux_manywheel_3.7m_cpu"
    docker:
      - image: "soumith/manylinux-cuda80"
    <<: *binary_linux_build

  binary_linux_manywheel_2.7m_cu80_build:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "binary_linux_manywheel_2.7m_cu80"
    docker:
      - image: "soumith/manylinux-cuda80"
    <<: *binary_linux_build

  binary_linux_manywheel_2.7mu_cu80_build:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "2.7mu"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "binary_linux_manywheel_2.7mu_cu80"
    docker:
      - image: "soumith/manylinux-cuda80"
    <<: *binary_linux_build

  binary_linux_manywheel_3.5m_cu80_build:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.5m"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "binary_linux_manywheel_3.5m_cu80"
    docker:
      - image: "soumith/manylinux-cuda80"
    <<: *binary_linux_build

  binary_linux_manywheel_3.6m_cu80_build:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.6m"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "binary_linux_manywheel_3.6m_cu80"
    docker:
      - image: "soumith/manylinux-cuda80"
    <<: *binary_linux_build

  binary_linux_manywheel_3.7m_cu80_build:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.7m"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "binary_linux_manywheel_3.7m_cu80"
    docker:
      - image: "soumith/manylinux-cuda80"
    <<: *binary_linux_build

  binary_linux_manywheel_2.7m_cu90_build:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "binary_linux_manywheel_2.7m_cu90"
    docker:
      - image: "soumith/manylinux-cuda90"
    <<: *binary_linux_build

  binary_linux_manywheel_2.7mu_cu90_build:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "2.7mu"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "binary_linux_manywheel_2.7mu_cu90"
    docker:
      - image: "soumith/manylinux-cuda90"
    <<: *binary_linux_build

  binary_linux_manywheel_3.5m_cu90_build:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.5m"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "binary_linux_manywheel_3.5m_cu90"
    docker:
      - image: "soumith/manylinux-cuda90"
    <<: *binary_linux_build

  binary_linux_manywheel_3.6m_cu90_build:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.6m"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "binary_linux_manywheel_3.6m_cu90"
    docker:
      - image: "soumith/manylinux-cuda90"
    <<: *binary_linux_build

  binary_linux_manywheel_3.7m_cu90_build:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.7m"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "binary_linux_manywheel_3.7m_cu90"
    docker:
      - image: "soumith/manylinux-cuda90"
    <<: *binary_linux_build

  binary_linux_manywheel_2.7m_cu100_build:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "binary_linux_manywheel_2.7m_cu100"
    docker:
      - image: "soumith/manylinux-cuda100"
    <<: *binary_linux_build

  binary_linux_manywheel_2.7mu_cu100_build:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "2.7mu"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "binary_linux_manywheel_2.7mu_cu100"
    docker:
      - image: "soumith/manylinux-cuda100"
    <<: *binary_linux_build

  binary_linux_manywheel_3.5m_cu100_build:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.5m"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "binary_linux_manywheel_3.5m_cu100"
    docker:
      - image: "soumith/manylinux-cuda100"
    <<: *binary_linux_build

  binary_linux_manywheel_3.6m_cu100_build:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.6m"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "binary_linux_manywheel_3.6m_cu100"
    docker:
      - image: "soumith/manylinux-cuda100"
    <<: *binary_linux_build

  binary_linux_manywheel_3.7m_cu100_build:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.7m"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "binary_linux_manywheel_3.7m_cu100"
    docker:
      - image: "soumith/manylinux-cuda100"
    <<: *binary_linux_build

  binary_linux_conda_2.7_cpu_build:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "2.7"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_linux_conda_2.7_cpu"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_3.5_cpu_build:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.5"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_linux_conda_3.5_cpu"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_3.6_cpu_build:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.6"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_linux_conda_3.6_cpu"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_3.7_cpu_build:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.7"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_linux_conda_3.7_cpu"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_2.7_cu80_build:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "2.7"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "binary_linux_conda_2.7_cu80"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_3.5_cu80_build:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.5"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "binary_linux_conda_3.5_cu80"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_3.6_cu80_build:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.6"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "binary_linux_conda_3.6_cu80"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_3.7_cu80_build:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.7"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "binary_linux_conda_3.7_cu80"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_2.7_cu90_build:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "2.7"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "binary_linux_conda_2.7_cu90"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_3.5_cu90_build:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.5"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "binary_linux_conda_3.5_cu90"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_3.6_cu90_build:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.6"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "binary_linux_conda_3.6_cu90"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_3.7_cu90_build:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.7"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "binary_linux_conda_3.7_cu90"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_2.7_cu100_build:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "2.7"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "binary_linux_conda_2.7_cu100"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_3.5_cu100_build:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.5"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "binary_linux_conda_3.5_cu100"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_3.6_cu100_build:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.6"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "binary_linux_conda_3.6_cu100"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_conda_3.7_cu100_build:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.7"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "binary_linux_conda_3.7_cu100"
    docker:
      - image: "soumith/conda-cuda"
    <<: *binary_linux_build

  binary_linux_libtorch_2.7m_cpu_build:
    environment:
      PACKAGE_TYPE: "libtorch"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_linux_libtorch_2.7m_cpu"
    docker:
      - image: "soumith/manylinux-cuda80"
    <<: *binary_linux_build

  binary_linux_libtorch_2.7m_cu80_build:
    environment:
      PACKAGE_TYPE: "libtorch"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "binary_linux_libtorch_2.7m_cu80"
    docker:
      - image: "soumith/manylinux-cuda80"
    <<: *binary_linux_build

  binary_linux_libtorch_2.7m_cu90_build:
    environment:
      PACKAGE_TYPE: "libtorch"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "binary_linux_libtorch_2.7m_cu90"
    docker:
      - image: "soumith/manylinux-cuda90"
    <<: *binary_linux_build

  binary_linux_libtorch_2.7m_cu100_build:
    environment:
      PACKAGE_TYPE: "libtorch"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "binary_linux_libtorch_2.7m_cu100"
    docker:
      - image: "soumith/manylinux-cuda100"
    <<: *binary_linux_build

  binary_macos_wheel_2.7_cpu_build:
    environment:
      PACKAGE_TYPE: "wheel"
      DESIRED_PYTHON: "2.7"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_macos_wheel_2.7_cpu"
    <<: *binary_mac_build

  binary_macos_wheel_3.5_cpu_build:
    environment:
      PACKAGE_TYPE: "wheel"
      DESIRED_PYTHON: "3.5"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_macos_wheel_3.5_cpu"
    <<: *binary_mac_build

  binary_macos_wheel_3.6_cpu_build:
    environment:
      PACKAGE_TYPE: "wheel"
      DESIRED_PYTHON: "3.6"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_macos_wheel_3.6_cpu"
    <<: *binary_mac_build

  binary_macos_wheel_3.7_cpu_build:
    environment:
      PACKAGE_TYPE: "wheel"
      DESIRED_PYTHON: "3.7"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_macos_wheel_3.7_cpu"
    <<: *binary_mac_build

  binary_macos_conda_2.7_cpu_build:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "2.7"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_macos_conda_2.7_cpu"
    <<: *binary_mac_build

  binary_macos_conda_3.5_cpu_build:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.5"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_macos_conda_3.5_cpu"
    <<: *binary_mac_build

  binary_macos_conda_3.6_cpu_build:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.6"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_macos_conda_3.6_cpu"
    <<: *binary_mac_build

  binary_macos_conda_3.7_cpu_build:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.7"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_macos_conda_3.7_cpu"
    <<: *binary_mac_build

  binary_macos_libtorch_2.7_cpu_build:
    environment:
      PACKAGE_TYPE: "libtorch"
      DESIRED_PYTHON: "2.7"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_macos_libtorch_2.7_cpu"
    <<: *binary_mac_build

  # Binary build tests
  # These are the smoke tests run right after the build, before the upload. If
  # these fail, the upload doesn't happen
  #############################################################################
  binary_linux_manywheel_2.7m_cpu_test_and_upload:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_linux_manywheel_2.7m_cpu"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
    <<: *binary_linux_test_and_upload

  binary_linux_manywheel_2.7mu_cpu_test_and_upload:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "2.7mu"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_linux_manywheel_2.7mu_cpu"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
    <<: *binary_linux_test_and_upload

  binary_linux_manywheel_3.5m_cpu_test_and_upload:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.5m"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_linux_manywheel_3.5m_cpu"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
    <<: *binary_linux_test_and_upload

  binary_linux_manywheel_3.6m_cpu_test_and_upload:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.6m"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_linux_manywheel_3.6m_cpu"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
    <<: *binary_linux_test_and_upload

  binary_linux_manywheel_3.7m_cpu_test_and_upload:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.7m"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_linux_manywheel_3.7m_cpu"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
    <<: *binary_linux_test_and_upload

  binary_linux_manywheel_2.7m_cu80_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "binary_linux_manywheel_2.7m_cu80"
      CUDA_VERSION: "8"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
    <<: *binary_linux_test_and_upload

  binary_linux_manywheel_2.7mu_cu80_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "2.7mu"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "binary_linux_manywheel_2.7mu_cu80"
      CUDA_VERSION: "8"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
    <<: *binary_linux_test_and_upload

  binary_linux_manywheel_3.5m_cu80_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.5m"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "binary_linux_manywheel_3.5m_cu80"
      CUDA_VERSION: "8"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
    <<: *binary_linux_test_and_upload

  binary_linux_manywheel_3.6m_cu80_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.6m"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "binary_linux_manywheel_3.6m_cu80"
      CUDA_VERSION: "8"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
    <<: *binary_linux_test_and_upload

  binary_linux_manywheel_3.7m_cu80_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.7m"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "binary_linux_manywheel_3.7m_cu80"
      CUDA_VERSION: "8"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
    <<: *binary_linux_test_and_upload

  binary_linux_manywheel_2.7m_cu90_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "binary_linux_manywheel_2.7m_cu90"
      CUDA_VERSION: "9"
      DOCKER_IMAGE: "soumith/manylinux-cuda90"
    <<: *binary_linux_test_and_upload

  binary_linux_manywheel_2.7mu_cu90_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "2.7mu"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "binary_linux_manywheel_2.7mu_cu90"
      CUDA_VERSION: "9"
      DOCKER_IMAGE: "soumith/manylinux-cuda90"
    <<: *binary_linux_test_and_upload

  binary_linux_manywheel_3.5m_cu90_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.5m"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "binary_linux_manywheel_3.5m_cu90"
      CUDA_VERSION: "9"
      DOCKER_IMAGE: "soumith/manylinux-cuda90"
    <<: *binary_linux_test_and_upload

  binary_linux_manywheel_3.6m_cu90_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.6m"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "binary_linux_manywheel_3.6m_cu90"
      CUDA_VERSION: "9"
      DOCKER_IMAGE: "soumith/manylinux-cuda90"
    <<: *binary_linux_test_and_upload

  binary_linux_manywheel_3.7m_cu90_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.7m"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "binary_linux_manywheel_3.7m_cu90"
      CUDA_VERSION: "9"
      DOCKER_IMAGE: "soumith/manylinux-cuda90"
    <<: *binary_linux_test_and_upload

  binary_linux_manywheel_2.7m_cu100_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "binary_linux_manywheel_2.7m_cu100"
      CUDA_VERSION: "10"
      DOCKER_IMAGE: "soumith/manylinux-cuda100"
    <<: *binary_linux_test_and_upload

  binary_linux_manywheel_2.7mu_cu100_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "2.7mu"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "binary_linux_manywheel_2.7mu_cu100"
      CUDA_VERSION: "10"
      DOCKER_IMAGE: "soumith/manylinux-cuda100"
    <<: *binary_linux_test_and_upload

  binary_linux_manywheel_3.5m_cu100_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.5m"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "binary_linux_manywheel_3.5m_cu100"
      CUDA_VERSION: "10"
      DOCKER_IMAGE: "soumith/manylinux-cuda100"
    <<: *binary_linux_test_and_upload

  binary_linux_manywheel_3.6m_cu100_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.6m"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "binary_linux_manywheel_3.6m_cu100"
      CUDA_VERSION: "10"
      DOCKER_IMAGE: "soumith/manylinux-cuda100"
    <<: *binary_linux_test_and_upload

  binary_linux_manywheel_3.7m_cu100_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.7m"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "binary_linux_manywheel_3.7m_cu100"
      CUDA_VERSION: "10"
      DOCKER_IMAGE: "soumith/manylinux-cuda100"
    <<: *binary_linux_test_and_upload

  binary_linux_conda_2.7_cpu_test_and_upload:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "2.7"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_linux_conda_2.7_cpu"
      DOCKER_IMAGE: "soumith/conda-cuda"
    <<: *binary_linux_test_and_upload

  binary_linux_conda_3.5_cpu_test_and_upload:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.5"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_linux_conda_3.5_cpu"
      DOCKER_IMAGE: "soumith/conda-cuda"
    <<: *binary_linux_test_and_upload

  binary_linux_conda_3.6_cpu_test_and_upload:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.6"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_linux_conda_3.6_cpu"
      DOCKER_IMAGE: "soumith/conda-cuda"
    <<: *binary_linux_test_and_upload

  binary_linux_conda_3.7_cpu_test_and_upload:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.7"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_linux_conda_3.7_cpu"
      DOCKER_IMAGE: "soumith/conda-cuda"
    <<: *binary_linux_test_and_upload

  binary_linux_conda_2.7_cu80_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "2.7"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "binary_linux_conda_2.7_cu80"
      CUDA_VERSION: "8"
      DOCKER_IMAGE: "soumith/conda-cuda"
    <<: *binary_linux_test_and_upload

  binary_linux_conda_3.5_cu80_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.5"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "binary_linux_conda_3.5_cu80"
      CUDA_VERSION: "8"
      DOCKER_IMAGE: "soumith/conda-cuda"
    <<: *binary_linux_test_and_upload

  binary_linux_conda_3.6_cu80_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.6"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "binary_linux_conda_3.6_cu80"
      CUDA_VERSION: "8"
      DOCKER_IMAGE: "soumith/conda-cuda"
    <<: *binary_linux_test_and_upload

  binary_linux_conda_3.7_cu80_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.7"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "binary_linux_conda_3.7_cu80"
      CUDA_VERSION: "8"
      DOCKER_IMAGE: "soumith/conda-cuda"
    <<: *binary_linux_test_and_upload

  binary_linux_conda_2.7_cu90_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "2.7"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "binary_linux_conda_2.7_cu90"
      CUDA_VERSION: "9"
      DOCKER_IMAGE: "soumith/conda-cuda"
    <<: *binary_linux_test_and_upload

  binary_linux_conda_3.5_cu90_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.5"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "binary_linux_conda_3.5_cu90"
      CUDA_VERSION: "9"
      DOCKER_IMAGE: "soumith/conda-cuda"
    <<: *binary_linux_test_and_upload

  binary_linux_conda_3.6_cu90_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.6"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "binary_linux_conda_3.6_cu90"
      CUDA_VERSION: "9"
      DOCKER_IMAGE: "soumith/conda-cuda"
    <<: *binary_linux_test_and_upload

  binary_linux_conda_3.7_cu90_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.7"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "binary_linux_conda_3.7_cu90"
      CUDA_VERSION: "9"
      DOCKER_IMAGE: "soumith/conda-cuda"
    <<: *binary_linux_test_and_upload

  binary_linux_conda_2.7_cu100_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "2.7"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "binary_linux_conda_2.7_cu100"
      CUDA_VERSION: "10"
      DOCKER_IMAGE: "soumith/conda-cuda"
    <<: *binary_linux_test_and_upload

  binary_linux_conda_3.5_cu100_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.5"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "binary_linux_conda_3.5_cu100"
      CUDA_VERSION: "10"
      DOCKER_IMAGE: "soumith/conda-cuda"
    <<: *binary_linux_test_and_upload

  binary_linux_conda_3.6_cu100_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.6"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "binary_linux_conda_3.6_cu100"
      CUDA_VERSION: "10"
      DOCKER_IMAGE: "soumith/conda-cuda"
    <<: *binary_linux_test_and_upload

  binary_linux_conda_3.7_cu100_test_and_upload:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.7"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "binary_linux_conda_3.7_cu100"
      CUDA_VERSION: "10"
      DOCKER_IMAGE: "soumith/conda-cuda"
    <<: *binary_linux_test_and_upload


# Non-upload binary jobs for PRsPACKAGE_TYPEDESIRED_PYTHONDESIRED_CUDA:
# Keywords: binary tests first round smoke tests binary pr test pr binary test


  binary_linux_manywheel_2.7mu_cpu_test:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "2.7mu"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_linux_manywheel_2.7mu_cpu"
      DO_NOT_UPLOAD: "DO_NOT_DELETE_THIS"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
    <<: *binary_linux_test_and_upload

  binary_linux_manywheel_3.5m_cu80_test:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.5m"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "binary_linux_manywheel_3.5m_cu80"
      CUDA_VERSION: "8"
      DO_NOT_UPLOAD: "DO_NOT_DELETE_THIS"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
    <<: *binary_linux_test_and_upload

  binary_linux_conda_3.6_cpu_test:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.6"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "binary_linux_conda_3.6_cpu"
      DO_NOT_UPLOAD: "DO_NOT_DELETE_THIS"
      DOCKER_IMAGE: "soumith/conda-cuda"
    <<: *binary_linux_test_and_upload

  binary_linux_conda_3.7_cu100_test:
    resource_class: gpu.medium
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.7"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "binary_linux_conda_3.7_cu100"
      CUDA_VERSION: "10"
      DO_NOT_UPLOAD: "DO_NOT_DELETE_THIS"
      DOCKER_IMAGE: "soumith/conda-cuda"
    <<: *binary_linux_test_and_upload


##############################################################################
# Smoke test specs individual job specifications
##############################################################################
  smoke_linux_manywheel_2.7m_cpu:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "smoke_linux_manywheel_2.7m_cpu"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
    <<: *smoke_linux_build

  smoke_linux_manywheel_2.7mu_cpu:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "2.7mu"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "smoke_linux_manywheel_2.7mu_cpu"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
    <<: *smoke_linux_build

  smoke_linux_manywheel_3.5m_cpu:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.5m"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "smoke_linux_manywheel_3.5m_cpu"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
    <<: *smoke_linux_build

  smoke_linux_manywheel_3.6m_cpu:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.6m"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "smoke_linux_manywheel_3.6m_cpu"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
    <<: *smoke_linux_build

  smoke_linux_manywheel_3.7m_cpu:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.7m"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "smoke_linux_manywheel_3.7m_cpu"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
    <<: *smoke_linux_build

  smoke_linux_manywheel_2.7m_cu80:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "smoke_linux_manywheel_2.7m_cu80"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
      CUDA_VERSION: "8"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_manywheel_2.7mu_cu80:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "2.7mu"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "smoke_linux_manywheel_2.7mu_cu80"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
      CUDA_VERSION: "8"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_manywheel_3.5m_cu80:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.5m"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "smoke_linux_manywheel_3.5m_cu80"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
      CUDA_VERSION: "8"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_manywheel_3.6m_cu80:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.6m"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "smoke_linux_manywheel_3.6m_cu80"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
      CUDA_VERSION: "8"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_manywheel_3.7m_cu80:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.7m"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "smoke_linux_manywheel_3.7m_cu80"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
      CUDA_VERSION: "8"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_manywheel_2.7m_cu90:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "smoke_linux_manywheel_2.7m_cu90"
      DOCKER_IMAGE: "soumith/manylinux-cuda90"
      CUDA_VERSION: "9"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_manywheel_2.7mu_cu90:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "2.7mu"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "smoke_linux_manywheel_2.7mu_cu90"
      DOCKER_IMAGE: "soumith/manylinux-cuda90"
      CUDA_VERSION: "9"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_manywheel_3.5m_cu90:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.5m"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "smoke_linux_manywheel_3.5m_cu90"
      DOCKER_IMAGE: "soumith/manylinux-cuda90"
      CUDA_VERSION: "9"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_manywheel_3.6m_cu90:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.6m"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "smoke_linux_manywheel_3.6m_cu90"
      DOCKER_IMAGE: "soumith/manylinux-cuda90"
      CUDA_VERSION: "9"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_manywheel_3.7m_cu90:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.7m"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "smoke_linux_manywheel_3.7m_cu90"
      DOCKER_IMAGE: "soumith/manylinux-cuda90"
      CUDA_VERSION: "9"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_manywheel_2.7m_cu100:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "smoke_linux_manywheel_2.7m_cu100"
      DOCKER_IMAGE: "soumith/manylinux-cuda100"
      CUDA_VERSION: "10"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_manywheel_2.7mu_cu100:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "2.7mu"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "smoke_linux_manywheel_2.7mu_cu100"
      DOCKER_IMAGE: "soumith/manylinux-cuda100"
      CUDA_VERSION: "10"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_manywheel_3.5m_cu100:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.5m"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "smoke_linux_manywheel_3.5m_cu100"
      DOCKER_IMAGE: "soumith/manylinux-cuda100"
      CUDA_VERSION: "10"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_manywheel_3.6m_cu100:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.6m"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "smoke_linux_manywheel_3.6m_cu100"
      DOCKER_IMAGE: "soumith/manylinux-cuda100"
      CUDA_VERSION: "10"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_manywheel_3.7m_cu100:
    environment:
      PACKAGE_TYPE: "manywheel"
      DESIRED_PYTHON: "3.7m"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "smoke_linux_manywheel_3.7m_cu100"
      DOCKER_IMAGE: "soumith/manylinux-cuda100"
      CUDA_VERSION: "10"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_conda_2.7_cpu:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "2.7"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "smoke_linux_conda_2.7_cpu"
      DOCKER_IMAGE: "soumith/conda-cuda"
    <<: *smoke_linux_build

  smoke_linux_conda_3.5_cpu:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.5"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "smoke_linux_conda_3.5_cpu"
      DOCKER_IMAGE: "soumith/conda-cuda"
    <<: *smoke_linux_build

  smoke_linux_conda_3.6_cpu:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.6"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "smoke_linux_conda_3.6_cpu"
      DOCKER_IMAGE: "soumith/conda-cuda"
    <<: *smoke_linux_build

  smoke_linux_conda_3.7_cpu:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.7"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "smoke_linux_conda_3.7_cpu"
      DOCKER_IMAGE: "soumith/conda-cuda"
    <<: *smoke_linux_build

  smoke_linux_conda_2.7_cu80:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "2.7"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "smoke_linux_conda_2.7_cu80"
      DOCKER_IMAGE: "soumith/conda-cuda"
      CUDA_VERSION: "8"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_conda_3.5_cu80:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.5"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "smoke_linux_conda_3.5_cu80"
      DOCKER_IMAGE: "soumith/conda-cuda"
      CUDA_VERSION: "8"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_conda_3.6_cu80:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.6"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "smoke_linux_conda_3.6_cu80"
      DOCKER_IMAGE: "soumith/conda-cuda"
      CUDA_VERSION: "8"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_conda_3.7_cu80:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.7"
      DESIRED_CUDA: "cu80"
      JOB_BASE_NAME: "smoke_linux_conda_3.7_cu80"
      DOCKER_IMAGE: "soumith/conda-cuda"
      CUDA_VERSION: "8"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_conda_2.7_cu90:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "2.7"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "smoke_linux_conda_2.7_cu90"
      DOCKER_IMAGE: "soumith/conda-cuda"
      CUDA_VERSION: "9"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_conda_3.5_cu90:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.5"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "smoke_linux_conda_3.5_cu90"
      DOCKER_IMAGE: "soumith/conda-cuda"
      CUDA_VERSION: "9"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_conda_3.6_cu90:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.6"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "smoke_linux_conda_3.6_cu90"
      DOCKER_IMAGE: "soumith/conda-cuda"
      CUDA_VERSION: "9"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_conda_3.7_cu90:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.7"
      DESIRED_CUDA: "cu90"
      JOB_BASE_NAME: "smoke_linux_conda_3.7_cu90"
      DOCKER_IMAGE: "soumith/conda-cuda"
      CUDA_VERSION: "9"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_conda_2.7_cu100:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "2.7"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "smoke_linux_conda_2.7_cu100"
      DOCKER_IMAGE: "soumith/conda-cuda"
      CUDA_VERSION: "10"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_conda_3.5_cu100:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.5"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "smoke_linux_conda_3.5_cu100"
      DOCKER_IMAGE: "soumith/conda-cuda"
      CUDA_VERSION: "10"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_conda_3.6_cu100:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.6"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "smoke_linux_conda_3.6_cu100"
      DOCKER_IMAGE: "soumith/conda-cuda"
      CUDA_VERSION: "10"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_conda_3.7_cu100:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.7"
      DESIRED_CUDA: "cu100"
      JOB_BASE_NAME: "smoke_linux_conda_3.7_cu100"
      DOCKER_IMAGE: "soumith/conda-cuda"
      CUDA_VERSION: "10"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_libtorch_2.7m_cpu_shared-with-deps:
    environment:
      PACKAGE_TYPE: "libtorch"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cpu"
      LIBTORCH_VARIANT: "shared-with-deps"
      JOB_BASE_NAME: "smoke_linux_libtorch_2.7m_cpu_shared-with-deps"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
    <<: *smoke_linux_build

  smoke_linux_libtorch_2.7m_cpu_shared-without-deps:
    environment:
      PACKAGE_TYPE: "libtorch"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cpu"
      LIBTORCH_VARIANT: "shared-without-deps"
      JOB_BASE_NAME: "smoke_linux_libtorch_2.7m_cpu_shared-without-deps"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
    <<: *smoke_linux_build

  smoke_linux_libtorch_2.7m_cpu_static-with-deps:
    environment:
      PACKAGE_TYPE: "libtorch"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cpu"
      LIBTORCH_VARIANT: "static-with-deps"
      JOB_BASE_NAME: "smoke_linux_libtorch_2.7m_cpu_static-with-deps"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
    <<: *smoke_linux_build

  smoke_linux_libtorch_2.7m_cpu_static-without-deps:
    environment:
      PACKAGE_TYPE: "libtorch"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cpu"
      LIBTORCH_VARIANT: "static-without-deps"
      JOB_BASE_NAME: "smoke_linux_libtorch_2.7m_cpu_static-without-deps"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
    <<: *smoke_linux_build

  smoke_linux_libtorch_2.7m_cu80_shared-with-deps:
    environment:
      PACKAGE_TYPE: "libtorch"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cu80"
      LIBTORCH_VARIANT: "shared-with-deps"
      JOB_BASE_NAME: "smoke_linux_libtorch_2.7m_cu80_shared-with-deps"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
      CUDA_VERSION: "8"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_libtorch_2.7m_cu80_shared-without-deps:
    environment:
      PACKAGE_TYPE: "libtorch"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cu80"
      LIBTORCH_VARIANT: "shared-without-deps"
      JOB_BASE_NAME: "smoke_linux_libtorch_2.7m_cu80_shared-without-deps"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
      CUDA_VERSION: "8"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_libtorch_2.7m_cu80_static-with-deps:
    environment:
      PACKAGE_TYPE: "libtorch"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cu80"
      LIBTORCH_VARIANT: "static-with-deps"
      JOB_BASE_NAME: "smoke_linux_libtorch_2.7m_cu80_static-with-deps"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
      CUDA_VERSION: "8"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_libtorch_2.7m_cu80_static-without-deps:
    environment:
      PACKAGE_TYPE: "libtorch"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cu80"
      LIBTORCH_VARIANT: "static-without-deps"
      JOB_BASE_NAME: "smoke_linux_libtorch_2.7m_cu80_static-without-deps"
      DOCKER_IMAGE: "soumith/manylinux-cuda80"
      CUDA_VERSION: "8"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_libtorch_2.7m_cu90_shared-with-deps:
    environment:
      PACKAGE_TYPE: "libtorch"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cu90"
      LIBTORCH_VARIANT: "shared-with-deps"
      JOB_BASE_NAME: "smoke_linux_libtorch_2.7m_cu90_shared-with-deps"
      DOCKER_IMAGE: "soumith/manylinux-cuda90"
      CUDA_VERSION: "9"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_libtorch_2.7m_cu90_shared-without-deps:
    environment:
      PACKAGE_TYPE: "libtorch"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cu90"
      LIBTORCH_VARIANT: "shared-without-deps"
      JOB_BASE_NAME: "smoke_linux_libtorch_2.7m_cu90_shared-without-deps"
      DOCKER_IMAGE: "soumith/manylinux-cuda90"
      CUDA_VERSION: "9"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_libtorch_2.7m_cu90_static-with-deps:
    environment:
      PACKAGE_TYPE: "libtorch"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cu90"
      LIBTORCH_VARIANT: "static-with-deps"
      JOB_BASE_NAME: "smoke_linux_libtorch_2.7m_cu90_static-with-deps"
      DOCKER_IMAGE: "soumith/manylinux-cuda90"
      CUDA_VERSION: "9"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_libtorch_2.7m_cu90_static-without-deps:
    environment:
      PACKAGE_TYPE: "libtorch"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cu90"
      LIBTORCH_VARIANT: "static-without-deps"
      JOB_BASE_NAME: "smoke_linux_libtorch_2.7m_cu90_static-without-deps"
      DOCKER_IMAGE: "soumith/manylinux-cuda90"
      CUDA_VERSION: "9"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_libtorch_2.7m_cu100_shared-with-deps:
    environment:
      PACKAGE_TYPE: "libtorch"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cu100"
      LIBTORCH_VARIANT: "shared-with-deps"
      JOB_BASE_NAME: "smoke_linux_libtorch_2.7m_cu100_shared-with-deps"
      DOCKER_IMAGE: "soumith/manylinux-cuda100"
      CUDA_VERSION: "10"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_libtorch_2.7m_cu100_shared-without-deps:
    environment:
      PACKAGE_TYPE: "libtorch"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cu100"
      LIBTORCH_VARIANT: "shared-without-deps"
      JOB_BASE_NAME: "smoke_linux_libtorch_2.7m_cu100_shared-without-deps"
      DOCKER_IMAGE: "soumith/manylinux-cuda100"
      CUDA_VERSION: "10"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_libtorch_2.7m_cu100_static-with-deps:
    environment:
      PACKAGE_TYPE: "libtorch"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cu100"
      LIBTORCH_VARIANT: "static-with-deps"
      JOB_BASE_NAME: "smoke_linux_libtorch_2.7m_cu100_static-with-deps"
      DOCKER_IMAGE: "soumith/manylinux-cuda100"
      CUDA_VERSION: "10"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_linux_libtorch_2.7m_cu100_static-without-deps:
    environment:
      PACKAGE_TYPE: "libtorch"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cu100"
      LIBTORCH_VARIANT: "static-without-deps"
      JOB_BASE_NAME: "smoke_linux_libtorch_2.7m_cu100_static-without-deps"
      DOCKER_IMAGE: "soumith/manylinux-cuda100"
      CUDA_VERSION: "10"
    resource_class: gpu.medium
    <<: *smoke_linux_build

  smoke_macos_wheel_2.7_cpu:
    environment:
      PACKAGE_TYPE: "wheel"
      DESIRED_PYTHON: "2.7"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "smoke_macos_wheel_2.7_cpu"
    <<: *smoke_mac_build

  smoke_macos_wheel_3.5_cpu:
    environment:
      PACKAGE_TYPE: "wheel"
      DESIRED_PYTHON: "3.5"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "smoke_macos_wheel_3.5_cpu"
    <<: *smoke_mac_build

  smoke_macos_wheel_3.6_cpu:
    environment:
      PACKAGE_TYPE: "wheel"
      DESIRED_PYTHON: "3.6"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "smoke_macos_wheel_3.6_cpu"
    <<: *smoke_mac_build

  smoke_macos_wheel_3.7_cpu:
    environment:
      PACKAGE_TYPE: "wheel"
      DESIRED_PYTHON: "3.7"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "smoke_macos_wheel_3.7_cpu"
    <<: *smoke_mac_build

  smoke_macos_conda_2.7_cpu:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "2.7"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "smoke_macos_conda_2.7_cpu"
    <<: *smoke_mac_build

  smoke_macos_conda_3.5_cpu:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.5"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "smoke_macos_conda_3.5_cpu"
    <<: *smoke_mac_build

  smoke_macos_conda_3.6_cpu:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.6"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "smoke_macos_conda_3.6_cpu"
    <<: *smoke_mac_build

  smoke_macos_conda_3.7_cpu:
    environment:
      PACKAGE_TYPE: "conda"
      DESIRED_PYTHON: "3.7"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "smoke_macos_conda_3.7_cpu"
    <<: *smoke_mac_build

  smoke_macos_libtorch_2.7m_cpu:
    environment:
      PACKAGE_TYPE: "libtorch"
      DESIRED_PYTHON: "2.7m"
      DESIRED_CUDA: "cpu"
      JOB_BASE_NAME: "smoke_macos_libtorch_2.7m_cpu"
    <<: *smoke_mac_build


##############################################################################
##############################################################################
# Workflows
##############################################################################
##############################################################################

# PR jobs pr builds
workflows:
  version: 2
  build:
    jobs:
      # Pytorch linux builds
      - pytorch_linux_trusty_py2_7_9_build
      - pytorch_linux_trusty_py2_7_9_test:
          requires:
            - pytorch_linux_trusty_py2_7_9_build
      - pytorch_linux_trusty_py2_7_build
      - pytorch_linux_trusty_py2_7_test:
          requires:
            - pytorch_linux_trusty_py2_7_build
      - pytorch_linux_trusty_py3_5_build
      - pytorch_linux_trusty_py3_5_test:
          requires:
            - pytorch_linux_trusty_py3_5_build
      - pytorch_linux_trusty_py3_6_gcc4_8_build
      - pytorch_linux_trusty_py3_6_gcc4_8_test:
          requires:
            - pytorch_linux_trusty_py3_6_gcc4_8_build
      - pytorch_linux_trusty_py3_6_gcc5_4_build
      - pytorch_linux_trusty_py3_6_gcc5_4_test:
          requires:
            - pytorch_linux_trusty_py3_6_gcc5_4_build
      - pytorch_linux_trusty_py3_6_gcc7_build
      - pytorch_linux_trusty_py3_6_gcc7_test:
          requires:
            - pytorch_linux_trusty_py3_6_gcc7_build
      - pytorch_linux_trusty_pynightly_build
      - pytorch_linux_trusty_pynightly_test:
          requires:
            - pytorch_linux_trusty_pynightly_build
      - pytorch_linux_xenial_py3_clang5_asan_build
      - pytorch_linux_xenial_py3_clang5_asan_test:
          requires:
            - pytorch_linux_xenial_py3_clang5_asan_build
      - pytorch_linux_xenial_cuda8_cudnn7_py3_build
      - pytorch_linux_xenial_cuda8_cudnn7_py3_test:
          requires:
            - pytorch_linux_xenial_cuda8_cudnn7_py3_build
      - pytorch_linux_xenial_cuda8_cudnn7_py3_multigpu_test:
          requires:
            - pytorch_linux_xenial_cuda8_cudnn7_py3_build
      - pytorch_linux_xenial_cuda8_cudnn7_py3_NO_AVX2_test:
          requires:
            - pytorch_linux_xenial_cuda8_cudnn7_py3_build
      - pytorch_linux_xenial_cuda8_cudnn7_py3_NO_AVX_NO_AVX2_test:
          requires:
            - pytorch_linux_xenial_cuda8_cudnn7_py3_build
      - pytorch_short_perf_test_gpu:
          requires:
            - pytorch_linux_xenial_cuda8_cudnn7_py3_build
      - pytorch_doc_push:
          requires:
            - pytorch_linux_xenial_cuda8_cudnn7_py3_build
      - pytorch_linux_xenial_cuda9_cudnn7_py2_build
      - pytorch_linux_xenial_cuda9_cudnn7_py2_test:
          requires:
            - pytorch_linux_xenial_cuda9_cudnn7_py2_build
      - pytorch_linux_xenial_cuda9_cudnn7_py3_build
      - pytorch_linux_xenial_cuda9_cudnn7_py3_test:
          requires:
            - pytorch_linux_xenial_cuda9_cudnn7_py3_build
      - pytorch_linux_xenial_cuda9_2_cudnn7_py3_gcc7_build
      - pytorch_linux_xenial_cuda9_2_cudnn7_py3_gcc7_test:
          requires:
            - pytorch_linux_xenial_cuda9_2_cudnn7_py3_gcc7_build
      - pytorch_linux_xenial_cuda10_cudnn7_py3_gcc7_build

      # Pytorch MacOS builds
      - pytorch_macos_10_13_py3_build
      - pytorch_macos_10_13_py3_test:
          requires:
            - pytorch_macos_10_13_py3_build
      - pytorch_macos_10_13_cuda9_2_cudnn7_py3_build

      # Caffe2 builds
      - caffe2_cmake_cuda9_0_cudnn7_ubuntu16_04_build
      - caffe2_cmake_cuda9_0_cudnn7_ubuntu16_04_test:
          requires:
            - caffe2_cmake_cuda9_0_cudnn7_ubuntu16_04_build
      - caffe2_py2_cuda9_0_cudnn7_ubuntu16_04_build
      - caffe2_py2_cuda9_0_cudnn7_ubuntu16_04_test:
          requires:
            - caffe2_py2_cuda9_0_cudnn7_ubuntu16_04_build
      - caffe2_py2_cuda9_1_cudnn7_ubuntu16_04_build
      - caffe2_py2_cuda9_1_cudnn7_ubuntu16_04_test:
          requires:
            - caffe2_py2_cuda9_1_cudnn7_ubuntu16_04_build
      - caffe2_py2_mkl_ubuntu16_04_build
      - caffe2_py2_mkl_ubuntu16_04_test:
          requires:
            - caffe2_py2_mkl_ubuntu16_04_build
      - caffe2_py2_gcc4_8_ubuntu14_04_build
      - caffe2_py2_gcc4_8_ubuntu14_04_test:
          requires:
            - caffe2_py2_gcc4_8_ubuntu14_04_build

      - caffe2_onnx_py2_gcc5_ubuntu16_04_build
      - caffe2_onnx_py2_gcc5_ubuntu16_04_test:
          requires:
            - caffe2_onnx_py2_gcc5_ubuntu16_04_build

      - caffe2_py2_cuda8_0_cudnn7_ubuntu16_04_build
      - caffe2_py2_cuda8_0_cudnn7_ubuntu16_04_test:
          requires:
            - caffe2_py2_cuda8_0_cudnn7_ubuntu16_04_build
      - caffe2_py2_clang3_8_ubuntu16_04_build
      - caffe2_py2_clang3_9_ubuntu16_04_build
      - caffe2_py2_clang7_ubuntu16_04_build
      - caffe2_py2_android_ubuntu16_04_build
      - caffe2_py2_cuda9_0_cudnn7_centos7_build
      - caffe2_py2_cuda9_0_cudnn7_centos7_test:
          requires:
            - caffe2_py2_cuda9_0_cudnn7_centos7_build

      # Caffe2 MacOS builds
      - caffe2_py2_ios_macos10_13_build
      - caffe2_py2_system_macos10_13_build

      # Binary builds (subset, to smoke test that they'll work)
      - binary_linux_manywheel_2.7mu_cpu_build
      - binary_linux_manywheel_2.7mu_cpu_test:
          requires:
              - binary_linux_manywheel_2.7mu_cpu_build
      - binary_linux_conda_3.7_cu100_build
      - binary_linux_conda_3.7_cu100_test:
          requires:
              - binary_linux_conda_3.7_cu100_build
      - binary_macos_conda_3.5_cpu_build


##############################################################################
# Daily smoke test trigger
##############################################################################
  binarysmoketests:
    triggers:
      - schedule:
          cron: "15 16 * * *"
          filters:
            branches:
              only:
                - master
    jobs:
      - smoke_linux_manywheel_2.7m_cpu
      - smoke_linux_manywheel_2.7mu_cpu
      - smoke_linux_manywheel_3.5m_cpu
      - smoke_linux_manywheel_3.6m_cpu
      - smoke_linux_manywheel_3.7m_cpu
      - smoke_linux_manywheel_2.7m_cu80
      - smoke_linux_manywheel_2.7mu_cu80
      - smoke_linux_manywheel_3.5m_cu80
      - smoke_linux_manywheel_3.6m_cu80
      - smoke_linux_manywheel_3.7m_cu80
      - smoke_linux_manywheel_2.7m_cu90
      - smoke_linux_manywheel_2.7mu_cu90
      - smoke_linux_manywheel_3.5m_cu90
      - smoke_linux_manywheel_3.6m_cu90
      - smoke_linux_manywheel_3.7m_cu90
      - smoke_linux_manywheel_2.7m_cu100
      - smoke_linux_manywheel_2.7mu_cu100
      - smoke_linux_manywheel_3.5m_cu100
      - smoke_linux_manywheel_3.6m_cu100
      - smoke_linux_manywheel_3.7m_cu100
      - smoke_linux_conda_2.7_cpu
      - smoke_linux_conda_3.5_cpu
      - smoke_linux_conda_3.6_cpu
      - smoke_linux_conda_3.7_cpu
      - smoke_linux_conda_2.7_cu80
      - smoke_linux_conda_3.5_cu80
      - smoke_linux_conda_3.6_cu80
      - smoke_linux_conda_3.7_cu80
      - smoke_linux_conda_2.7_cu90
      - smoke_linux_conda_3.5_cu90
      - smoke_linux_conda_3.6_cu90
      - smoke_linux_conda_3.7_cu90
      - smoke_linux_conda_2.7_cu100
      - smoke_linux_conda_3.5_cu100
      - smoke_linux_conda_3.6_cu100
      - smoke_linux_conda_3.7_cu100
      - smoke_linux_libtorch_2.7m_cpu_shared-with-deps
      - smoke_linux_libtorch_2.7m_cpu_shared-without-deps
      - smoke_linux_libtorch_2.7m_cpu_static-with-deps
      - smoke_linux_libtorch_2.7m_cpu_static-without-deps
      - smoke_linux_libtorch_2.7m_cu80_shared-with-deps
      - smoke_linux_libtorch_2.7m_cu80_shared-without-deps
      - smoke_linux_libtorch_2.7m_cu80_static-with-deps
      - smoke_linux_libtorch_2.7m_cu80_static-without-deps
      - smoke_linux_libtorch_2.7m_cu90_shared-with-deps
      - smoke_linux_libtorch_2.7m_cu90_shared-without-deps
      - smoke_linux_libtorch_2.7m_cu90_static-with-deps
      - smoke_linux_libtorch_2.7m_cu90_static-without-deps
      - smoke_linux_libtorch_2.7m_cu100_shared-with-deps
      - smoke_linux_libtorch_2.7m_cu100_shared-without-deps
      - smoke_linux_libtorch_2.7m_cu100_static-with-deps
      - smoke_linux_libtorch_2.7m_cu100_static-without-deps
      - smoke_macos_wheel_2.7_cpu
      - smoke_macos_wheel_3.5_cpu
      - smoke_macos_wheel_3.6_cpu
      - smoke_macos_wheel_3.7_cpu
      - smoke_macos_conda_2.7_cpu
      - smoke_macos_conda_3.5_cpu
      - smoke_macos_conda_3.6_cpu
      - smoke_macos_conda_3.7_cpu
      - smoke_macos_libtorch_2.7_cpu


##############################################################################
# Daily binary build trigger
##############################################################################
  binarybuilds:
    triggers:
      - schedule:
          cron: "5 5 * * *"
          filters:
            branches:
              only:
                - master
    jobs:
      - binary_linux_manywheel_2.7m_cpu_build
      - binary_linux_manywheel_2.7mu_cpu_build
      - binary_linux_manywheel_3.5m_cpu_build
      - binary_linux_manywheel_3.6m_cpu_build
      - binary_linux_manywheel_3.7m_cpu_build
      - binary_linux_manywheel_2.7m_cu80_build
      - binary_linux_manywheel_2.7mu_cu80_build
      - binary_linux_manywheel_3.5m_cu80_build
      - binary_linux_manywheel_3.6m_cu80_build
      - binary_linux_manywheel_3.7m_cu80_build
      - binary_linux_manywheel_2.7m_cu90_build
      - binary_linux_manywheel_2.7mu_cu90_build
      - binary_linux_manywheel_3.5m_cu90_build
      - binary_linux_manywheel_3.6m_cu90_build
      - binary_linux_manywheel_3.7m_cu90_build
      - binary_linux_manywheel_2.7m_cu100_build
      - binary_linux_manywheel_2.7mu_cu100_build
      - binary_linux_manywheel_3.5m_cu100_build
      - binary_linux_manywheel_3.6m_cu100_build
      - binary_linux_manywheel_3.7m_cu100_build
      - binary_linux_conda_2.7_cpu_build
      - binary_linux_conda_3.5_cpu_build
      - binary_linux_conda_3.6_cpu_build
      - binary_linux_conda_3.7_cpu_build
      - binary_linux_conda_2.7_cu80_build
      - binary_linux_conda_3.5_cu80_build
      - binary_linux_conda_3.6_cu80_build
      - binary_linux_conda_3.7_cu80_build
      - binary_linux_conda_2.7_cu90_build
      - binary_linux_conda_3.5_cu90_build
      - binary_linux_conda_3.6_cu90_build
      - binary_linux_conda_3.7_cu90_build
      - binary_linux_conda_2.7_cu100_build
      - binary_linux_conda_3.5_cu100_build
      - binary_linux_conda_3.6_cu100_build
      - binary_linux_conda_3.7_cu100_build
      - binary_linux_libtorch_2.7m_cpu_build
      - binary_linux_libtorch_2.7m_cu80_build
      - binary_linux_libtorch_2.7m_cu90_build
      - binary_linux_libtorch_2.7m_cu100_build
      - binary_macos_wheel_2.7_cpu_build
      - binary_macos_wheel_3.5_cpu_build
      - binary_macos_wheel_3.6_cpu_build
      - binary_macos_wheel_3.7_cpu_build
      - binary_macos_conda_2.7_cpu_build
      - binary_macos_conda_3.5_cpu_build
      - binary_macos_conda_3.6_cpu_build
      - binary_macos_conda_3.7_cpu_build
      - binary_macos_libtorch_2.7_cpu_build

      - binary_linux_manywheel_2.7m_cpu_test_and_upload:
          context: org-member
          requires:
            - binary_linux_manywheel_2.7m_cpu_build
      - binary_linux_manywheel_2.7mu_cpu_test_and_upload:
          context: org-member
          requires:
            - binary_linux_manywheel_2.7mu_cpu_build
      - binary_linux_manywheel_3.5m_cpu_test_and_upload:
          context: org-member
          requires:
            - binary_linux_manywheel_3.5m_cpu_build
      - binary_linux_manywheel_3.6m_cpu_test_and_upload:
          context: org-member
          requires:
            - binary_linux_manywheel_3.6m_cpu_build
      - binary_linux_manywheel_3.7m_cpu_test_and_upload:
          context: org-member
          requires:
            - binary_linux_manywheel_3.7m_cpu_build
      - binary_linux_manywheel_2.7m_cu80_test_and_upload:
          context: org-member
          requires:
            - binary_linux_manywheel_2.7m_cu80_build
      - binary_linux_manywheel_2.7mu_cu80_test_and_upload:
          context: org-member
          requires:
            - binary_linux_manywheel_2.7mu_cu80_build
      - binary_linux_manywheel_3.5m_cu80_test_and_upload:
          context: org-member
          requires:
            - binary_linux_manywheel_3.5m_cu80_build
      - binary_linux_manywheel_3.6m_cu80_test_and_upload:
          context: org-member
          requires:
            - binary_linux_manywheel_3.6m_cu80_build
      - binary_linux_manywheel_3.7m_cu80_test_and_upload:
          context: org-member
          requires:
            - binary_linux_manywheel_3.7m_cu80_build
      - binary_linux_manywheel_2.7m_cu90_test_and_upload:
          context: org-member
          requires:
            - binary_linux_manywheel_2.7m_cu90_build
      - binary_linux_manywheel_2.7mu_cu90_test_and_upload:
          context: org-member
          requires:
            - binary_linux_manywheel_2.7mu_cu90_build
      - binary_linux_manywheel_3.5m_cu90_test_and_upload:
          context: org-member
          requires:
            - binary_linux_manywheel_3.5m_cu90_build
      - binary_linux_manywheel_3.6m_cu90_test_and_upload:
          context: org-member
          requires:
            - binary_linux_manywheel_3.6m_cu90_build
      - binary_linux_manywheel_3.7m_cu90_test_and_upload:
          context: org-member
          requires:
            - binary_linux_manywheel_3.7m_cu90_build
      - binary_linux_manywheel_2.7m_cu100_test_and_upload:
          context: org-member
          requires:
            - binary_linux_manywheel_2.7m_cu100_build
      - binary_linux_manywheel_2.7mu_cu100_test_and_upload:
          context: org-member
          requires:
            - binary_linux_manywheel_2.7mu_cu100_build
      - binary_linux_manywheel_3.5m_cu100_test_and_upload:
          context: org-member
          requires:
            - binary_linux_manywheel_3.5m_cu100_build
      - binary_linux_manywheel_3.6m_cu100_test_and_upload:
          context: org-member
          requires:
            - binary_linux_manywheel_3.6m_cu100_build
      - binary_linux_manywheel_3.7m_cu100_test_and_upload:
          context: org-member
          requires:
            - binary_linux_manywheel_3.7m_cu100_build
      - binary_linux_conda_2.7_cpu_test_and_upload:
          context: org-member
          requires:
            - binary_linux_conda_2.7_cpu_build
      - binary_linux_conda_3.5_cpu_test_and_upload:
          context: org-member
          requires:
            - binary_linux_conda_3.5_cpu_build
      - binary_linux_conda_3.6_cpu_test_and_upload:
          context: org-member
          requires:
            - binary_linux_conda_3.6_cpu_build
      - binary_linux_conda_3.7_cpu_test_and_upload:
          context: org-member
          requires:
            - binary_linux_conda_3.7_cpu_build
      - binary_linux_conda_2.7_cu80_test_and_upload:
          context: org-member
          requires:
            - binary_linux_conda_2.7_cu80_build
      - binary_linux_conda_3.5_cu80_test_and_upload:
          context: org-member
          requires:
            - binary_linux_conda_3.5_cu80_build
      - binary_linux_conda_3.6_cu80_test_and_upload:
          context: org-member
          requires:
            - binary_linux_conda_3.6_cu80_build
      - binary_linux_conda_3.7_cu80_test_and_upload:
          context: org-member
          requires:
            - binary_linux_conda_3.7_cu80_build
      - binary_linux_conda_2.7_cu90_test_and_upload:
          context: org-member
          requires:
            - binary_linux_conda_2.7_cu90_build
      - binary_linux_conda_3.5_cu90_test_and_upload:
          context: org-member
          requires:
            - binary_linux_conda_3.5_cu90_build
      - binary_linux_conda_3.6_cu90_test_and_upload:
          context: org-member
          requires:
            - binary_linux_conda_3.6_cu90_build
      - binary_linux_conda_3.7_cu90_test_and_upload:
          context: org-member
          requires:
            - binary_linux_conda_3.7_cu90_build
      - binary_linux_conda_2.7_cu100_test_and_upload:
          context: org-member
          requires:
            - binary_linux_conda_2.7_cu100_build
      - binary_linux_conda_3.5_cu100_test_and_upload:
          context: org-member
          requires:
            - binary_linux_conda_3.5_cu100_build
      - binary_linux_conda_3.6_cu100_test_and_upload:
          context: org-member
          requires:
            - binary_linux_conda_3.6_cu100_build
      - binary_linux_conda_3.7_cu100_test_and_upload:
          context: org-member
          requires:
            - binary_linux_conda_3.7_cu100_build
